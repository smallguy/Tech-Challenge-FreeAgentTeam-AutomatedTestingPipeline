# 修复代码生成提示词（实例ID：django__django-13693）
## 代码仓库
django/django

## 原始问题描述
django-admin runserver and get_child_arguments() crashes on Windows and Python < 3.8.
Description
	
"django-admin runserver" fails with the following error:
Traceback (most recent call last):
 File "c:\users\someone\appdata\local\programs\python\python37\lib\runpy.py", line 193, in _run_module_as_main
	"__main__", mod_spec)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\runpy.py", line 85, in _run_code
	exec(code, run_globals)
 File "C:\Users\someone\AppData\Local\Programs\Python\Python37\Scripts\django-admin.exe\__main__.py", line 7, in <module>
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\__init__.py", line 401, in execute_from_command_line
	utility.execute()
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\__init__.py", line 395, in execute
	self.fetch_command(subcommand).run_from_argv(self.argv)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\base.py", line 330, in run_from_argv
	self.execute(*args, **cmd_options)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\commands\runserver.py", line 61, in execute
	super().execute(*args, **options)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\base.py", line 371, in execute
	output = self.handle(*args, **options)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\commands\runserver.py", line 96, in handle
	self.run(**options)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\core\management\commands\runserver.py", line 103, in run
	autoreload.run_with_reloader(self.inner_run, **options)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\utils\autoreload.py", line 616, in run_with_reloader
	exit_code = restart_with_reloader()
 File "c:\users\someone\appdata\local\programs\python\python37\lib\site-packages\django\utils\autoreload.py", line 244, in restart_with_reloader
	p = subprocess.run(args, env=new_environ, close_fds=False)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\subprocess.py", line 488, in run
	with Popen(*popenargs, **kwargs) as process:
 File "c:\users\someone\appdata\local\programs\python\python37\lib\subprocess.py", line 800, in __init__
	restore_signals, start_new_session)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\subprocess.py", line 1148, in _execute_child
	args = list2cmdline(args)
 File "c:\users\someone\appdata\local\programs\python\python37\lib\subprocess.py", line 555, in list2cmdline
	needquote = (" " in arg) or ("\t" in arg) or not arg
TypeError: argument of type 'WindowsPath' is not iterable
Environment:
Windows 10
Python: 3.7.6
Django: 3.1.3
Steps to reproduce:
django-admin startproject mysite
set PYTHONPATH=<thelocaldir>
django-admin runserver --settings=mysite.settings
Apparently django.utils.autoreload.get_child_arguments returns WindowsPath("C:\Users\someone\AppData\Local\Programs\Python\Python37\Scripts\django-admin.exe") as the first argument,
and subprocess.Popen expects a string and is not able to use Path.
The following monkey-patch fixes the error:
def get_child_arguments_override():
	args = autoreload._get_child_arguments()
	for i, arg in enumerate(args):
		if isinstance(arg, Path):
			args[i] = str(arg)
	return args
autoreload._get_child_arguments = autoreload.get_child_arguments
autoreload.get_child_arguments = get_child_arguments_override


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/utils_tests/test_autoreload.py b/tests/utils_tests/test_autoreload.py
--- a/tests/utils_tests/test_autoreload.py
+++ b/tests/utils_tests/test_autoreload.py
@@ -178,10 +178,10 @@ def test_exe_fallback(self):
         with tempfile.TemporaryDirectory() as tmpdir:
             exe_path = Path(tmpdir) / 'django-admin.exe'
             exe_path.touch()
-            with mock.patch('sys.argv', [exe_path.with_suffix(''), 'runserver']):
+            with mock.patch('sys.argv', [str(exe_path.with_suffix('')), 'runserver']):
                 self.assertEqual(
                     autoreload.get_child_arguments(),
-                    [exe_path, 'runserver']
+                    [str(exe_path), 'runserver']
                 )
 
     @mock.patch('sys.warnoptions', [])
@@ -189,10 +189,10 @@ def test_entrypoint_fallback(self):
         with tempfile.TemporaryDirectory() as tmpdir:
             script_path = Path(tmpdir) / 'django-admin-script.py'
             script_path.touch()
-            with mock.patch('sys.argv', [script_path.with_name('django-admin'), 'runserver']):
+            with mock.patch('sys.argv', [str(script_path.with_name('django-admin')), 'runserver']):
                 self.assertEqual(
                     autoreload.get_child_arguments(),
-                    [sys.executable, script_path, 'runserver']
+                    [sys.executable, str(script_path), 'runserver']
                 )
 
     @mock.patch('sys.argv', ['does-not-exist', 'runserver'])
@@ -433,7 +433,7 @@ def test_manage_py(self):
         with tempfile.TemporaryDirectory() as temp_dir:
             script = Path(temp_dir) / 'manage.py'
             script.touch()
-            argv = [script, 'runserver']
+            argv = [str(script), 'runserver']
             mock_call = self.patch_autoreload(argv)
             autoreload.restart_with_reloader()
             self.assertEqual(mock_call.call_count, 1)