# ä¿®å¤ä»£ç ç”Ÿæˆæç¤ºè¯ï¼ˆå®ä¾‹IDï¼šdjango__django-11772ï¼‰
## ä»£ç ä»“åº“
django/django

## åŸå§‹é—®é¢˜æè¿°
Template Cache "make_template_fragment_key" function speed up + simplify (also discussing switch to alternate hashes)
Description
	 
		(last modified by Daniel)
	 
The make_template_fragment_key function in django.core.cache.utils has the following (minor) issues:
Using urllib.quote for vary_on args, is not needed any more - it was originally added to make the unhashed strings safe to send to memcached and similar restricted systems. But since the value is hashed, this is now adding nothing. (See â€‹https://github.com/django/django/commit/ebc1325721e43808cef4334edaffc23a43f86614#diff-702b69be0100a594fd6fea1e4ab2feb1).
Use of the MD5 hashing function is disallowed on certain (odd) systems, not being FIPS compliant. See (â€‹https://github.com/django/django/pull/10605).
Creates a string of all joined vary_on args to send to the hashing function, rather than using the hashlib .update() method.
Here is a version solving these, switching to SHA256, and speeding up the function quite a bit:
â€‹https://github.com/danthedeckie/django/tree/simplified_make_template_fragment_key
And PR: â€‹https://github.com/django/django/pull/11772
And here's the repo showing performance improvement:
â€‹https://github.com/danthedeckie/make_template_fragment_key_test
Which seems to be faster in every case.
The downside of this is that the cache key is now different from before. The tests have been updated to the new values.
There are other cache key generating functions used in other places which use MD5 still - if switching to SHA256 it would make sense to me to change those at the same time, meaning only one time invalidating keys on upgrade.
Thoughts?


## å‚è€ƒé»„é‡‘è¡¥ä¸ï¼ˆæ­£ç¡®çš„ä¿®å¤æ–¹æ¡ˆï¼‰
diff --git a/tests/cache/tests.py b/tests/cache/tests.py
--- a/tests/cache/tests.py
+++ b/tests/cache/tests.py
@@ -2306,15 +2306,27 @@ def test_without_vary_on(self):
 
     def test_with_one_vary_on(self):
         key = make_template_fragment_key('foo', ['abc'])
-        self.assertEqual(key, 'template.cache.foo.900150983cd24fb0d6963f7d28e17f72')
+        self.assertEqual(key, 'template.cache.foo.493e283d571a73056196f1a68efd0f66')
 
     def test_with_many_vary_on(self):
         key = make_template_fragment_key('bar', ['abc', 'def'])
-        self.assertEqual(key, 'template.cache.bar.4b35f12ab03cec09beec4c21b2d2fa88')
+        self.assertEqual(key, 'template.cache.bar.17c1a507a0cb58384f4c639067a93520')
 
     def test_proper_escaping(self):
         key = make_template_fragment_key('spam', ['abc:def%'])
-        self.assertEqual(key, 'template.cache.spam.f27688177baec990cdf3fbd9d9c3f469')
+        self.assertEqual(key, 'template.cache.spam.06c8ae8e8c430b69fb0a6443504153dc')
+
+    def test_with_ints_vary_on(self):
+        key = make_template_fragment_key('foo', [1, 2, 3, 4, 5])
+        self.assertEqual(key, 'template.cache.foo.7ae8fd2e0d25d651c683bdeebdb29461')
+
+    def test_with_unicode_vary_on(self):
+        key = make_template_fragment_key('foo', ['42Âº', 'ğŸ˜€'])
+        self.assertEqual(key, 'template.cache.foo.7ced1c94e543668590ba39b3c08b0237')
+
+    def test_long_vary_on(self):
+        key = make_template_fragment_key('foo', ['x' * 10000])
+        self.assertEqual(key, 'template.cache.foo.3670b349b5124aa56bdb50678b02b23a')
 
 
 class CacheHandlerTest(SimpleTestCase):