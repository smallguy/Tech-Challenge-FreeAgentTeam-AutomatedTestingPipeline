# 修复代码生成提示词（实例ID：django__django-14983）
## 代码仓库
django/django

## 原始问题描述
makemigrations generates "wrong" numbered migration file if squashed migrations are in place
Description
	
When an app has migrations 0001_initial and 0002_auto_20141202_1234 that are squashed to 0001_squashed_0002_auto_20141202_1234, a new call to makemigrations will generate a migration file called 0002_auto_20141202_2345 instead of 0003_auto_20141202_2345 which is quite irritating as long as 0002_auto_20141202_1234 is still around. It does make sense though when only 0001_squashed_0002_auto_20141202_1234 is left.
Although the latter case eventually hits every project, I'd prefer the former.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/migrations/test_autodetector.py b/tests/migrations/test_autodetector.py
--- a/tests/migrations/test_autodetector.py
+++ b/tests/migrations/test_autodetector.py
@@ -2664,6 +2664,26 @@ def test_add_model_with_field_removed_from_base_model(self):
         self.assertOperationAttributes(changes, 'app', 0, 0, name='title', model_name='readable')
         self.assertOperationAttributes(changes, 'app', 0, 1, name='book')
 
+    def test_parse_number(self):
+        tests = [
+            ('no_number', None),
+            ('0001_initial', 1),
+            ('0002_model3', 2),
+            ('0002_auto_20380101_1112', 2),
+            ('0002_squashed_0003', 3),
+            ('0002_model2_squashed_0003_other4', 3),
+            ('0002_squashed_0003_squashed_0004', 4),
+            ('0002_model2_squashed_0003_other4_squashed_0005_other6', 5),
+            ('0002_custom_name_20380101_1112_squashed_0003_model', 3),
+            ('2_squashed_4', 4),
+        ]
+        for migration_name, expected_number in tests:
+            with self.subTest(migration_name=migration_name):
+                self.assertEqual(
+                    MigrationAutodetector.parse_number(migration_name),
+                    expected_number,
+                )
+
 
 class MigrationSuggestNameTests(SimpleTestCase):
     def test_no_operations(self):
diff --git a/tests/migrations/test_commands.py b/tests/migrations/test_commands.py
--- a/tests/migrations/test_commands.py
+++ b/tests/migrations/test_commands.py
@@ -1956,6 +1956,21 @@ class Meta:
             out_value = out.getvalue()
             self.assertIn('Add field created to book', out_value)
 
+    @override_settings(
+        MIGRATION_MODULES={'migrations': 'migrations.test_migrations_squashed'},
+    )
+    def test_makemigrations_continues_number_sequence_after_squash(self):
+        with self.temporary_migration_module(module='migrations.test_migrations_squashed'):
+            with captured_stdout() as out:
+                call_command(
+                    'makemigrations',
+                    'migrations',
+                    interactive=False,
+                    empty=True,
+                )
+            out_value = out.getvalue()
+            self.assertIn('0003_auto', out_value)
+
 
 class SquashMigrationsTests(MigrationTestBase):
     """