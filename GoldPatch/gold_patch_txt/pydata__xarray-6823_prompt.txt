# 修复代码生成提示词（实例ID：pydata__xarray-6823）
## 代码仓库
pydata/xarray

## 原始问题描述
RuntimeError when formatting sparse-backed DataArray in f-string
### What happened?

On upgrading from xarray 2022.3.0 to 2022.6.0, f-string formatting of sparse-backed DataArray raises an exception.

### What did you expect to happen?

- Code does not error, or
- A breaking change is listed in the [“Breaking changes”](https://docs.xarray.dev/en/stable/whats-new.html#breaking-changes) section of the docs.

### Minimal Complete Verifiable Example

```Python
import pandas as pd
import xarray as xr

s = pd.Series(
    range(4),
    index=pd.MultiIndex.from_product([list("ab"), list("cd")]),
)

da = xr.DataArray.from_series(s, sparse=True)

print(f"{da}")
```


### MVCE confirmation

- [X] Minimal example — the example is as focused as reasonably possible to demonstrate the underlying issue in xarray.
- [X] Complete example — the example is self-contained, including all data and the text of any traceback.
- [X] Verifiable example — the example copy & pastes into an IPython prompt or [Binder notebook](https://mybinder.org/v2/gh/pydata/xarray/main?urlpath=lab/tree/doc/examples/blank_template.ipynb), returning the result.
- [X] New issue — a search of GitHub Issues suggests this is not a duplicate.

### Relevant log output

```Python
# xarray 2022.3.0:

<xarray.DataArray (level_0: 2, level_1: 2)>
<COO: shape=(2, 2), dtype=float64, nnz=4, fill_value=nan>                                         
Coordinates:                                     
  * level_0  (level_0) object 'a' 'b'
  * level_1  (level_1) object 'c' 'd'

# xarray 2022.6.0:

Traceback (most recent call last):                                                                
  File "/home/khaeru/bug.py", line 11, in <module>
    print(f"{da}")
  File "/home/khaeru/.local/lib/python3.10/site-packages/xarray/core/common.py", line 168, in __format__                                           
    return self.values.__format__(format_spec)
  File "/home/khaeru/.local/lib/python3.10/site-packages/xarray/core/dataarray.py", line 685, in values                                            
    return self.variable.values
  File "/home/khaeru/.local/lib/python3.10/site-packages/xarray/core/variable.py", line 527, in values                                             
    return _as_array_or_item(self._data)
  File "/home/khaeru/.local/lib/python3.10/site-packages/xarray/core/variable.py", line 267, in _as_array_or_item                                                                                   
    data = np.asarray(data)
  File "/home/khaeru/.local/lib/python3.10/site-packages/sparse/_sparse_array.py", line 229, in __array__                                                                                           
    raise RuntimeError(
RuntimeError: Cannot convert a sparse array to dense automatically. To manually densify, use the todense method.
```


### Anything else we need to know?

Along with the versions below, I have confirmed the error occurs with both sparse 0.12 and sparse 0.13.

### Environment

<details>
INSTALLED VERSIONS
------------------
commit: None
python: 3.10.4 (main, Jun 29 2022, 12:14:53) [GCC 11.2.0]
python-bits: 64
OS: Linux
OS-release: 5.15.0-41-generic
machine: x86_64
processor: x86_64
byteorder: little
LC_ALL: None
LANG: en_CA.UTF-8
LOCALE: ('en_CA', 'UTF-8')
libhdf5: 1.10.7
libnetcdf: 4.8.1

xarray: 2022.6.0
pandas: 1.4.2
numpy: 1.22.4
scipy: 1.8.0
netCDF4: 1.5.8
pydap: None
h5netcdf: 0.12.0
h5py: 3.6.0
Nio: None
zarr: None
cftime: 1.5.2
nc_time_axis: None
PseudoNetCDF: None
rasterio: None
cfgrib: None
iris: None
bottleneck: 1.3.2
dask: 2022.01.0+dfsg
distributed: 2022.01.0+ds.1
matplotlib: 3.5.1
cartopy: 0.20.2
seaborn: 0.11.2
numbagg: None
fsspec: 2022.01.0
cupy: None
pint: 0.18
sparse: 0.13.0
flox: None
numpy_groupies: None
setuptools: 62.1.0
pip: 22.0.2
conda: None
pytest: 6.2.5
IPython: 7.31.1
sphinx: 4.5.0
</details>


## 参考黄金补丁（正确的修复方案）
diff --git a/xarray/tests/test_formatting.py b/xarray/tests/test_formatting.py
--- a/xarray/tests/test_formatting.py
+++ b/xarray/tests/test_formatting.py
@@ -391,7 +391,10 @@ def test_diff_dataset_repr(self) -> None:
     def test_array_repr(self) -> None:
         ds = xr.Dataset(coords={"foo": [1, 2, 3], "bar": [1, 2, 3]})
         ds[(1, 2)] = xr.DataArray([0], dims="test")
-        actual = formatting.array_repr(ds[(1, 2)])
+        ds_12 = ds[(1, 2)]
+
+        # Test repr function behaves correctly:
+        actual = formatting.array_repr(ds_12)
         expected = dedent(
             """\
         <xarray.DataArray (1, 2) (test: 1)>
@@ -401,6 +404,14 @@ def test_array_repr(self) -> None:
 
         assert actual == expected
 
+        # Test repr, str prints returns correctly as well:
+        assert repr(ds_12) == expected
+        assert str(ds_12) == expected
+
+        # f-strings (aka format(...)) by default should use the repr:
+        actual = f"{ds_12}"
+        assert actual == expected
+
         with xr.set_options(display_expand_data=False):
             actual = formatting.array_repr(ds[(1, 2)])
             expected = dedent(
@@ -422,24 +433,27 @@ def test_array_repr_variable(self) -> None:
 
     @requires_dask
     def test_array_scalar_format(self) -> None:
-        var = xr.DataArray(0)
-        assert var.__format__("") == "0"
-        assert var.__format__("d") == "0"
-        assert var.__format__(".2f") == "0.00"
+        # Test numpy scalars:
+        var = xr.DataArray(np.array(0))
+        assert format(var, "") == repr(var)
+        assert format(var, "d") == "0"
+        assert format(var, ".2f") == "0.00"
 
-        var = xr.DataArray([0.1, 0.2])
-        assert var.__format__("") == "[0.1 0.2]"
-        with pytest.raises(TypeError) as excinfo:
-            var.__format__(".2f")
-        assert "unsupported format string passed to" in str(excinfo.value)
+        # Test dask scalars, not supported however:
+        import dask.array as da
 
-        # also check for dask
-        var = var.chunk(chunks={"dim_0": 1})
-        assert var.__format__("") == "[0.1 0.2]"
+        var = xr.DataArray(da.array(0))
+        assert format(var, "") == repr(var)
         with pytest.raises(TypeError) as excinfo:
-            var.__format__(".2f")
+            format(var, ".2f")
         assert "unsupported format string passed to" in str(excinfo.value)
 
+        # Test numpy arrays raises:
+        var = xr.DataArray([0.1, 0.2])
+        with pytest.raises(NotImplementedError) as excinfo:  # type: ignore
+            format(var, ".2f")
+        assert "Using format_spec is only supported" in str(excinfo.value)
+
 
 def test_inline_variable_array_repr_custom_repr() -> None:
     class CustomArray: