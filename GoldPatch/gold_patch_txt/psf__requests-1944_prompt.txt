# 修复代码生成提示词（实例ID：psf__requests-1944）
## 代码仓库
psf/requests

## 原始问题描述
Why decode the response body of a redirect?
Requests fails on the URL `http://www.whatbird.com/forum/index.php?/gallery/image/291517-foo/`, which is a 301 redirect to

```
http://www.whatbird.com/forum/index.php?/gallery/image/291517-title-paused-jewel-allens-hummingbird-a-backyard-bird-painting-in-oil-by-camille-engel/
```

. The issue seems to be that the server's initial 301 response has a header falsely claiming that the response body (a simple HTML page) is gzipped, when it's actually uncompressed.

When resolving redirects, Requests does (in `requests.sessions.resolve_redirects`):

```
resp.content  # Consume socket so it can be released
```

which attempts to decode

One could legitimately say this is the server's problem. However, conceptually, why decode the response body of a redirect, which won't get returned? Other programs (Chromium, Firefox, `curl`) don't do this. For example, `curl` gives an error, as expected, when not following redirects:

```
$ curl --compressed 'http://www.whatbird.com/forum/index.php?/gallery/image/291517-foo/'
curl: (61) Error while processing content unencoding: invalid code lengths set
```

whereas it works if you add the `--location` flag (follow redirects).
# Example of error

```
Python 3.3.2+ (default, Oct  9 2013, 14:56:03) 
[GCC 4.8.1] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import requests ; requests.get('http://www.whatbird.com/forum/index.php?/gallery/image/291517-foo/')
Traceback (most recent call last):
  File "./requests/packages/urllib3/response.py", line 199, in read
    data = self._decoder.decompress(data)
zlib.error: Error -3 while decompressing data: incorrect header check

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "./requests/models.py", line 629, in generate
    for chunk in self.raw.stream(chunk_size, decode_content=True):
  File "./requests/packages/urllib3/response.py", line 236, in stream
    data = self.read(amt=amt, decode_content=decode_content)
  File "./requests/packages/urllib3/response.py", line 204, in read
    e)
requests.packages.urllib3.exceptions.DecodeError: ('Received response with content-encoding: gzip, but failed to decode it.', error('Error -3 while decompressing data: incorrect header check',))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "<stdin>", line 1, in <module>
  File "./requests/api.py", line 55, in get
    return request('get', url, **kwargs)
  File "./requests/api.py", line 44, in request
    return session.request(method=method, url=url, **kwargs)
  File "./requests/sessions.py", line 393, in request
    resp = self.send(prep, **send_kwargs)
  File "./requests/sessions.py", line 496, in send
    r = adapter.send(request, **kwargs)
  File "./requests/adapters.py", line 391, in send
    r.content
  File "./requests/models.py", line 691, in content
    self._content = bytes().join(self.iter_content(CONTENT_CHUNK_SIZE)) or bytes()
  File "./requests/models.py", line 634, in generate
    raise ContentDecodingError(e)
requests.exceptions.ContentDecodingError: ('Received response with content-encoding: gzip, but failed to decode it.', error('Error -3 while decompressing data: incorrect header check',))
```



## 参考黄金补丁（正确的修复方案）
diff --git a/test_requests.py b/test_requests.py
--- a/test_requests.py
+++ b/test_requests.py
@@ -917,6 +917,45 @@ def test_auth_is_retained_for_redirect_on_host(self):
 
         assert h1 == h2
 
+    def test_manual_redirect_with_partial_body_read(self):
+        s = requests.Session()
+        r1 = s.get(httpbin('redirect/2'), allow_redirects=False, stream=True)
+        assert r1.is_redirect
+        rg = s.resolve_redirects(r1, r1.request, stream=True)
+
+        # read only the first eight bytes of the response body,
+        # then follow the redirect
+        r1.iter_content(8)
+        r2 = next(rg)
+        assert r2.is_redirect
+
+        # read all of the response via iter_content,
+        # then follow the redirect
+        for _ in r2.iter_content():
+            pass
+        r3 = next(rg)
+        assert not r3.is_redirect
+
+    def _patch_adapter_gzipped_redirect(self, session, url):
+        adapter = session.get_adapter(url=url)
+        org_build_response = adapter.build_response
+        self._patched_response = False
+
+        def build_response(*args, **kwargs):
+            resp = org_build_response(*args, **kwargs)
+            if not self._patched_response:
+                resp.raw.headers['content-encoding'] = 'gzip'
+                self._patched_response = True
+            return resp
+
+        adapter.build_response = build_response
+
+    def test_redirect_with_wrong_gzipped_header(self):
+        s = requests.Session()
+        url = httpbin('redirect/1')
+        self._patch_adapter_gzipped_redirect(s, url)
+        s.get(url)
+
 
 class TestContentEncodingDetection(unittest.TestCase):
 
@@ -1321,7 +1360,7 @@ def test_data_argument_accepts_tuples(list_of_tuples):
             hooks=default_hooks()
         )
         assert p.body == urlencode(data)
-        
+
 
 if __name__ == '__main__':
     unittest.main()