# 修复代码生成提示词（实例ID：sphinx-doc__sphinx-10807）
## 代码仓库
sphinx-doc/sphinx

## 原始问题描述
Create a ToC entry for every function, method, class, etc
It would be useful to have an option that causes Sphinx to automatically create a TOC entry for every function, class, and method.  (In the absence of this, tables of contents are of limited value).
automodule places members under docstring headers
### Describe the bug

Whenever you use

```
.. automodule:: mod
   :members:
```

Sphinx inserts the module docstring, then inserts the members under that docstring. If the docstring contains headers, the functions are all placed under the bottommost header. 

This is hard to tell in most themes, because it isn't actually evident what lives under a given header. However, you can tell if you inspect the webpage.

This came up as I was working on creating an extension to add autodoc functions to the toctree (see https://gist.github.com/agoose77/e8f0f8f7d7133e73483ca5c2dd7b907f and https://github.com/sphinx-doc/sphinx/issues/6316). With this behavior, it places the functions under the module headers in the toctree, which is not what I want.

### How to Reproduce

I have created a small reproducer project here https://github.com/asmeurer/sphinx-automodule-test. There is a build here https://www.asmeurer.com/sphinx-automodule-test/

You can see if you inspect the page that `mod.function` is under `subheader`, and `mod.submod.function2` is not. 

In practice, this comes up in SymPy in several places, for example on [this doc page](https://docs.sympy.org/latest/modules/physics/wigner.html). With the current behavior and the extension I am working on, all the functions in that module end up under the "authors" header in the module docstring, whereas they ought to be at the top-level.

### Expected behavior

I dug into the code and it looks like the problem is that `.. automodule` with `:members:` simply generates RST like

```rst
.. module:: mod

<module docstring here ...>

Header
======

.. autofunction:: mod.function
```

Which tricks RST into thinking that the module headers are part of the top-level document.

It would be better if this instead put the module docstring as content of the `module` directive, like

```rst
.. module:: mod
   
   <module docstring here ...>
   
   Header
   ======

.. autofunction:: mod.function
```

However, `py:module` is different from every other directive in that it does not allow content. Is there a reason for this? If py:module worked like every other directive and allowed the docstring to be included as content, then something along the lines of

```diff
diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py
index 931c14049..5037d340e 100644
--- a/sphinx/ext/autodoc/__init__.py
+++ b/sphinx/ext/autodoc/__init__.py
@@ -956,6 +956,12 @@ class ModuleDocumenter(Documenter):
         merge_members_option(self.options)
         self.__all__: Optional[Sequence[str]] = None

+    def add_content(self, more_content: Optional[StringList]) -> None:
+        old_indent = self.indent
+        self.indent += '   '
+        super().add_content(more_content)
+        self.indent = old_indent
+
     @classmethod
     def can_document_member(cls, member: Any, membername: str, isattr: bool, parent: Any
                             ) -> bool:
```

would fix this (not claiming that is the cleanest fix on the autodoc side, but I believe it would get the job done).

### Your project

https://github.com/asmeurer/sphinx-automodule-test

### Screenshots

_No response_

### OS

Mac

### Python version

3.9

### Sphinx version

master branch

### Sphinx extensions

sphinx.ext.autodoc

### Extra tools

_No response_

### Additional context

_No response_


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/roots/test-toctree-domain-objects/conf.py b/tests/roots/test-toctree-domain-objects/conf.py
new file mode 100644
diff --git a/tests/roots/test-toctree-domain-objects/domains.rst b/tests/roots/test-toctree-domain-objects/domains.rst
new file mode 100644
--- /dev/null
+++ b/tests/roots/test-toctree-domain-objects/domains.rst
@@ -0,0 +1,39 @@
+test-domain-objects
+===================
+
+.. py:module:: hello
+
+.. py:function:: world() -> str
+
+   Prints "Hello, World!" to stdout
+
+.. py:class:: HelloWorldPrinter
+
+   Controls printing of hello world
+
+   .. py:method:: set_language()
+
+      Sets the language of the HelloWorldPrinter instance
+
+   .. py:attribute:: output_count
+
+      Count of outputs of "Hello, World!"
+
+   .. py:method:: print_normal()
+      :async:
+      :classmethod:
+
+      Prints the normal form of "Hello, World!"
+
+   .. py:method:: print()
+
+      Prints "Hello, World!", including in the chosen language
+
+.. py:function:: exit()
+   :module: sys
+
+   Quits the interpreter
+
+.. js:function:: fetch(resource)
+
+   Fetches the given resource, returns a Promise
\ No newline at end of file
diff --git a/tests/roots/test-toctree-domain-objects/index.rst b/tests/roots/test-toctree-domain-objects/index.rst
new file mode 100644
--- /dev/null
+++ b/tests/roots/test-toctree-domain-objects/index.rst
@@ -0,0 +1,6 @@
+.. toctree::
+   :numbered:
+   :caption: Table of Contents
+   :name: mastertoc
+
+   domains
diff --git a/tests/test_environment_toctree.py b/tests/test_environment_toctree.py
--- a/tests/test_environment_toctree.py
+++ b/tests/test_environment_toctree.py
@@ -2,7 +2,7 @@
 
 import pytest
 from docutils import nodes
-from docutils.nodes import bullet_list, comment, list_item, reference, title
+from docutils.nodes import bullet_list, comment, list_item, literal, reference, title
 
 from sphinx import addnodes
 from sphinx.addnodes import compact_paragraph, only
@@ -126,6 +126,44 @@ def test_glob(app):
     assert app.env.numbered_toctrees == set()
 
 
+@pytest.mark.sphinx('dummy', testroot='toctree-domain-objects')
+def test_domain_objects(app):
+    includefiles = ['domains']
+
+    app.build()
+
+    assert app.env.toc_num_entries['index'] == 0
+    assert app.env.toc_num_entries['domains'] == 9
+    assert app.env.toctree_includes['index'] == includefiles
+    for file in includefiles:
+        assert 'index' in app.env.files_to_rebuild[file]
+    assert app.env.glob_toctrees == set()
+    assert app.env.numbered_toctrees == {'index'}
+
+    # tocs
+    toctree = app.env.tocs['domains']
+    assert_node(toctree,
+                [bullet_list, list_item, (compact_paragraph,  # [0][0]
+                                          [bullet_list, (list_item,  # [0][1][0]
+                                                         [list_item,  # [0][1][1]
+                                                          (compact_paragraph,  # [0][1][1][0]
+                                                           [bullet_list, (list_item,  # [0][1][1][1][0]
+                                                                          list_item,
+                                                                          list_item,
+                                                                          list_item)])],  # [0][1][1][1][3]
+                                                         list_item,
+                                                         list_item)])])  # [0][1][1]
+
+    assert_node(toctree[0][0],
+                [compact_paragraph, reference, "test-domain-objects"])
+
+    assert_node(toctree[0][1][0],
+                [list_item, ([compact_paragraph, reference, literal, "world()"])])
+
+    assert_node(toctree[0][1][1][1][3],
+                [list_item, ([compact_paragraph, reference, literal, "HelloWorldPrinter.print()"])])
+
+
 @pytest.mark.sphinx('xml', testroot='toctree')
 @pytest.mark.test_params(shared_result='test_environment_toctree_basic')
 def test_get_toc_for(app):
diff --git a/tests/test_ext_autodoc_automodule.py b/tests/test_ext_autodoc_automodule.py
--- a/tests/test_ext_autodoc_automodule.py
+++ b/tests/test_ext_autodoc_automodule.py
@@ -19,7 +19,7 @@ def test_empty_all(app):
         '',
         '.. py:module:: target.empty_all',
         '',
-        'docsting of empty_all module.',
+        '   docsting of empty_all module.',
         '',
     ]