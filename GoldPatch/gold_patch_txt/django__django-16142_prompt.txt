# 修复代码生成提示词（实例ID：django__django-16142）
## 代码仓库
django/django

## 原始问题描述
get_language_from_request should not fallback to settings.LANGUAGE_CODE
Description
	 
		(last modified by sergioisidoro)
	 
I'm writing a middleware to fallback to a different language depending on the TLD of the domain of the HTTP_HOST
However, I noticed that get_language_from_request falls back to the settings default language, which will almost always take precedence in this case.
This is quite confusing, since settings.LANGUAGE_CODE is not "from the request", but from the application configuration, and it feels that the responsibility of falling back to the default language should lie in the Middleware, not in this function.
Solution / Summary: get_language_from_request should return None, to communicate to the middleware that there was no language from request, and that the middleware should fallback to the default. Otherwise if the get_language_from_request returns "EN" we don't know if "EN" is actually a request preference, or because it came from the default settings.LANGUAGE_CODE


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/i18n/tests.py b/tests/i18n/tests.py
--- a/tests/i18n/tests.py
+++ b/tests/i18n/tests.py
@@ -2137,8 +2137,22 @@ def test_other_lang_with_prefix(self):
         response = self.client.get("/fr/simple/")
         self.assertEqual(response.content, b"Oui")
 
-    def test_unprefixed_language_other_than_accept_language(self):
+    def test_unprefixed_language_with_accept_language(self):
+        """'Accept-Language' is respected."""
         response = self.client.get("/simple/", HTTP_ACCEPT_LANGUAGE="fr")
+        self.assertRedirects(response, "/fr/simple/")
+
+    def test_unprefixed_language_with_cookie_language(self):
+        """A language set in the cookies is respected."""
+        self.client.cookies.load({settings.LANGUAGE_COOKIE_NAME: "fr"})
+        response = self.client.get("/simple/")
+        self.assertRedirects(response, "/fr/simple/")
+
+    def test_unprefixed_language_with_non_valid_language(self):
+        response = self.client.get("/simple/", HTTP_ACCEPT_LANGUAGE="fi")
+        self.assertEqual(response.content, b"Yes")
+        self.client.cookies.load({settings.LANGUAGE_COOKIE_NAME: "fi"})
+        response = self.client.get("/simple/")
         self.assertEqual(response.content, b"Yes")
 
     def test_page_with_dash(self):
@@ -2214,10 +2228,7 @@ def test_get_language_from_request(self):
 
     def test_get_language_from_request_null(self):
         lang = trans_null.get_language_from_request(None)
-        self.assertEqual(lang, "en")
-        with override_settings(LANGUAGE_CODE="de"):
-            lang = trans_null.get_language_from_request(None)
-            self.assertEqual(lang, "de")
+        self.assertEqual(lang, None)
 
     def test_specific_language_codes(self):
         # issue 11915