# 修复代码生成提示词（实例ID：scikit-learn__scikit-learn-13368）
## 代码仓库
scikit-learn/scikit-learn

## 原始问题描述
cross_val_predict returns bad prediction when evaluated on a dataset with very few samples
#### Description
`cross_val_predict` returns bad prediction when evaluated on a dataset with very few samples on 1 class, causing class being ignored on some CV splits.

#### Steps/Code to Reproduce
```python
from sklearn.datasets import *
from sklearn.linear_model import *
from sklearn.model_selection import *
X, y = make_classification(n_samples=100, n_features=2, n_redundant=0, n_informative=2,
                           random_state=1, n_clusters_per_class=1)
# Change the first sample to a new class
y[0] = 2
clf = LogisticRegression()
cv = StratifiedKFold(n_splits=2, random_state=1)
train, test = list(cv.split(X, y))
yhat_proba = cross_val_predict(clf, X, y, cv=cv, method="predict_proba")
print(yhat_proba)
```

#### Expected Results
```
[[0.06105412 0.93894588 0.        ]
 [0.92512247 0.07487753 0.        ]
 [0.93896471 0.06103529 0.        ]
 [0.04345507 0.95654493 0.        ]
```

#### Actual Results
```
[[0. 0. 0.        ]
 [0. 0. 0.        ]
 [0. 0. 0.        ]
 [0. 0. 0.        ]
```
#### Versions
Verified on the scikit latest dev version.



## 参考黄金补丁（正确的修复方案）
diff --git a/sklearn/model_selection/tests/test_validation.py b/sklearn/model_selection/tests/test_validation.py
--- a/sklearn/model_selection/tests/test_validation.py
+++ b/sklearn/model_selection/tests/test_validation.py
@@ -975,6 +975,26 @@ def test_cross_val_predict_pandas():
         cross_val_predict(clf, X_df, y_ser)
 
 
+@pytest.mark.filterwarnings('ignore: Default solver will be changed')  # 0.22
+@pytest.mark.filterwarnings('ignore: Default multi_class will')  # 0.22
+def test_cross_val_predict_unbalanced():
+    X, y = make_classification(n_samples=100, n_features=2, n_redundant=0,
+                               n_informative=2, n_clusters_per_class=1,
+                               random_state=1)
+    # Change the first sample to a new class
+    y[0] = 2
+    clf = LogisticRegression(random_state=1)
+    cv = StratifiedKFold(n_splits=2, random_state=1)
+    train, test = list(cv.split(X, y))
+    yhat_proba = cross_val_predict(clf, X, y, cv=cv, method="predict_proba")
+    assert y[test[0]][0] == 2  # sanity check for further assertions
+    assert np.all(yhat_proba[test[0]][:, 2] == 0)
+    assert np.all(yhat_proba[test[0]][:, 0:1] > 0)
+    assert np.all(yhat_proba[test[1]] > 0)
+    assert_array_almost_equal(yhat_proba.sum(axis=1), np.ones(y.shape),
+                              decimal=12)
+
+
 @pytest.mark.filterwarnings('ignore: You should specify a value')  # 0.22
 def test_cross_val_score_sparse_fit_params():
     iris = load_iris()