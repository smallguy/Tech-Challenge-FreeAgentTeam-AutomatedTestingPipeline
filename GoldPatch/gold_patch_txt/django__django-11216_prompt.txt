# 修复代码生成提示词（实例ID：django__django-11216）
## 代码仓库
django/django

## 原始问题描述
Prevent ManifestStaticFilesStorage from leaving behind intermediate files
Description
	
Currently when using ManifestStaticFilesStorage, collectstatic generates duplicate versions of some files. 
For example looking at the output for contrib.admin for Django 1.11.5, there is:
admin/css/base.css
admin/css/base.5af66c1b1797.css
admin/css/base.6b517d0d5813.css
admin/css/base.31652d31b392.css
This is exacerbated when using something like WhiteNoise's CompressedStaticFilesMixin, which then has to spend extra time generating gzip and Brotli compressed versions of every file (or else try and work around it: ​evansd/whitenoise#147).
This was called unavoidable/working as intended according to:
https://code.djangoproject.com/ticket/24452#comment:16
​https://github.com/django/django/pull/6507
However now that it's looking like CachedStaticFilesStorage will end up being removed (​mailing list thread; or at the very least we're discouraging people from using it, since it's buggy in several scenarios) - the intermediate files needn't be left behind.
Even before CachedStaticFilesStorage ends up being removed, we could perhaps add a keep_intermediate_files property to HashedFilesMixin, that is set to False for CachedStaticFilesStorage and True for ManifestStaticFilesStorage, allowing us to fix the latter in the meantime.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/staticfiles_tests/test_storage.py b/tests/staticfiles_tests/test_storage.py
--- a/tests/staticfiles_tests/test_storage.py
+++ b/tests/staticfiles_tests/test_storage.py
@@ -445,6 +445,18 @@ def test_missing_entry(self):
         # File exists on disk
         self.hashed_file_path(missing_file_name)
 
+    def test_intermediate_files(self):
+        cached_files = os.listdir(os.path.join(settings.STATIC_ROOT, 'cached'))
+        # Intermediate files shouldn't be created for reference.
+        self.assertEqual(
+            len([
+                cached_file
+                for cached_file in cached_files
+                if cached_file.startswith('relative.')
+            ]),
+            2,
+        )
+
 
 @override_settings(STATICFILES_STORAGE='staticfiles_tests.storage.SimpleStorage')
 class TestCollectionSimpleStorage(CollectionTestCase):