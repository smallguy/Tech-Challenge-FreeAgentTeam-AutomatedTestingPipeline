# 修复代码生成提示词（实例ID：django__django-14341）
## 代码仓库
django/django

## 原始问题描述
Database cache.delete uses cursor after it is closed
Description
	 
		(last modified by ecogels)
	 
The return bool(cursor.rowcount) is outside of the with block, so the cursor will have been closed at that point.
From the DB API 2.0 spec: "The cursor will be unusable from this point forward" ​https://www.python.org/dev/peps/pep-0249/#Cursor.close
As the main backend drivers don't mind it I suppose that is is open to interpretation.
PR ​https://github.com/django/django/pull/14341


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/cache/tests.py b/tests/cache/tests.py
--- a/tests/cache/tests.py
+++ b/tests/cache/tests.py
@@ -24,6 +24,7 @@
 from django.core.cache.backends.base import InvalidCacheBackendError
 from django.core.cache.utils import make_template_fragment_key
 from django.db import close_old_connections, connection, connections
+from django.db.backends.utils import CursorWrapper
 from django.http import (
     HttpRequest, HttpResponse, HttpResponseNotModified, StreamingHttpResponse,
 )
@@ -1116,6 +1117,27 @@ def test_delete_many_num_queries(self):
         with self.assertNumQueries(1):
             cache.delete_many(['a', 'b', 'c'])
 
+    def test_delete_cursor_rowcount(self):
+        """
+        The rowcount attribute should not be checked on a closed cursor.
+        """
+        class MockedCursorWrapper(CursorWrapper):
+            is_closed = False
+
+            def close(self):
+                self.cursor.close()
+                self.is_closed = True
+
+            @property
+            def rowcount(self):
+                if self.is_closed:
+                    raise Exception('Cursor is closed.')
+                return self.cursor.rowcount
+
+        cache.set_many({'a': 1, 'b': 2})
+        with mock.patch('django.db.backends.utils.CursorWrapper', MockedCursorWrapper):
+            self.assertIs(cache.delete('a'), True)
+
     def test_zero_cull(self):
         self._perform_cull_test('zero_cull', 50, 18)