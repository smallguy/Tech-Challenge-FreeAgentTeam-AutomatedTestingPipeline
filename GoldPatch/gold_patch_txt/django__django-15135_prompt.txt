# 修复代码生成提示词（实例ID：django__django-15135）
## 代码仓库
django/django

## 原始问题描述
Saving parent object after setting on child leads to unexpected data loss in bulk_update().
Description
	
Consider following example:
class Child(models.Model):
	pass
class Parent(models.Model):
	child = models.ForeignKey(Child, on_delete=models.CASCADE, null=True)
parent = Parent.objects.create(child=None)
parent.child = Child()
parent.child.save()
Parent.objects.bulk_update([parent], fields=["child"])
Expected behavior:
parent model instance was updated with the ID to the child in the database.
Actual behavior:
Parent model is still referencing Null.
There should probably be some check for ForeignKeys in the bulk_update logic, and if one is updated, the ID of the child model should be re-copied to the child_id field that is actually being written to the database.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/queries/test_bulk_update.py b/tests/queries/test_bulk_update.py
--- a/tests/queries/test_bulk_update.py
+++ b/tests/queries/test_bulk_update.py
@@ -7,7 +7,8 @@
 
 from .models import (
     Article, CustomDbColumn, CustomPk, Detail, Individual, JSONFieldNullable,
-    Member, Note, Number, Order, Paragraph, SpecialCategory, Tag, Valid,
+    Member, Note, Number, Order, Paragraph, RelatedObject, SingleObject,
+    SpecialCategory, Tag, Valid,
 )
 
 
@@ -250,3 +251,32 @@ def test_json_field(self):
             obj.json_field = {'c': obj.json_field['a'] + 1}
         JSONFieldNullable.objects.bulk_update(objs, ['json_field'])
         self.assertCountEqual(JSONFieldNullable.objects.filter(json_field__has_key='c'), objs)
+
+    def test_nullable_fk_after_related_save(self):
+        parent = RelatedObject.objects.create()
+        child = SingleObject()
+        parent.single = child
+        parent.single.save()
+        RelatedObject.objects.bulk_update([parent], fields=['single'])
+        self.assertEqual(parent.single_id, parent.single.pk)
+        parent.refresh_from_db()
+        self.assertEqual(parent.single, child)
+
+    def test_unsaved_parent(self):
+        parent = RelatedObject.objects.create()
+        parent.single = SingleObject()
+        msg = (
+            "bulk_update() prohibited to prevent data loss due to unsaved "
+            "related object 'single'."
+        )
+        with self.assertRaisesMessage(ValueError, msg):
+            RelatedObject.objects.bulk_update([parent], fields=['single'])
+
+    def test_unspecified_unsaved_parent(self):
+        parent = RelatedObject.objects.create()
+        parent.single = SingleObject()
+        parent.f = 42
+        RelatedObject.objects.bulk_update([parent], fields=['f'])
+        parent.refresh_from_db()
+        self.assertEqual(parent.f, 42)
+        self.assertIsNone(parent.single)