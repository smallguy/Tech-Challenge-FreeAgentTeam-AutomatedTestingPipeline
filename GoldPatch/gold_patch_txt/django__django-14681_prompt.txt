# 修复代码生成提示词（实例ID：django__django-14681）
## 代码仓库
django/django

## 原始问题描述
CSRF failure incorrectly reported on upload when there is a problem with storage
Description
	
Minimal reproduction app is in the attachment, although the only changes from the default template are:
csrfbug/settings.py:
MEDIA_URL = '/media/'
MEDIA_ROOT = 'media/'
FILE_UPLOAD_MAX_MEMORY_SIZE = 1024 * 1024
FILE_UPLOAD_TEMP_DIR = MEDIA_ROOT + 'tmp'
app/models.py
class File(models.Model):
	file = models.FileField()
app/admin.py
from .models import File
admin.site.register(File)
Required setup for the attached app:
python manage.py migrate
python manage.py createsuperuser
Steps to reproduce
1) runserver
2) navigate and login to /admin/
3) navigate to /admin/app/file/add/
Scenario 1. default state - file uploads works as expected
Scenario 2. remove media/tmp directory - file uploads works only for files that fit in FILE_UPLOAD_MAX_MEMORY_SIZE, error otherwise (see below)
Scenario 3. remove whole media directory - error reported for all file uploads (see below)
Exact error message:
Forbidden (403)
CSRF verification failed. Request aborted.
Reason given for failure: CSRF token missing or incorrect.
Expected behaviour:
Filesystem error or similar reporting incorrect media storage setup. 
Comment:
Yes, the setup in this scenario is invalid to begin with, but the error message has nothing to do with the actual problem. 
I suspect a real problem with an underlying filesystem will also get covered in the same way.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/csrf_tests/tests.py b/tests/csrf_tests/tests.py
--- a/tests/csrf_tests/tests.py
+++ b/tests/csrf_tests/tests.py
@@ -3,7 +3,7 @@
 from django.conf import settings
 from django.contrib.sessions.backends.cache import SessionStore
 from django.core.exceptions import ImproperlyConfigured
-from django.http import HttpRequest, HttpResponse
+from django.http import HttpRequest, HttpResponse, UnreadablePostError
 from django.middleware.csrf import (
     CSRF_ALLOWED_CHARS, CSRF_SESSION_KEY, CSRF_TOKEN_LENGTH, REASON_BAD_ORIGIN,
     REASON_CSRF_TOKEN_MISSING, REASON_NO_CSRF_COOKIE, CsrfViewMiddleware,
@@ -99,6 +99,23 @@ def is_secure(self):
         return getattr(self, '_is_secure_override', False)
 
 
+class PostErrorRequest(TestingHttpRequest):
+    """
+    TestingHttpRequest that can raise errors when accessing POST data.
+    """
+    post_error = None
+
+    def _get_post(self):
+        if self.post_error is not None:
+            raise self.post_error
+        return self._post
+
+    def _set_post(self, post):
+        self._post = post
+
+    POST = property(_get_post, _set_post)
+
+
 class CsrfViewMiddlewareTestMixin:
     """
     Shared methods and tests for session-based and cookie-based tokens.
@@ -131,10 +148,12 @@ def assertCookiesSet(self, req, resp, expected_secrets):
         secrets_set = [_unmask_cipher_token(cookie) for cookie in cookies_set]
         self.assertEqual(secrets_set, expected_secrets)
 
-    def _get_request(self, method=None, cookie=None):
+    def _get_request(self, method=None, cookie=None, request_class=None):
         if method is None:
             method = 'GET'
-        req = TestingHttpRequest()
+        if request_class is None:
+            request_class = TestingHttpRequest
+        req = request_class()
         req.method = method
         if cookie is not None:
             self._set_csrf_cookie(req, cookie)
@@ -142,7 +161,7 @@ def _get_request(self, method=None, cookie=None):
 
     def _get_csrf_cookie_request(
         self, method=None, cookie=None, post_token=None, meta_token=None,
-        token_header=None,
+        token_header=None, request_class=None,
     ):
         """
         The method argument defaults to "GET". The cookie argument defaults to
@@ -156,7 +175,11 @@ def _get_csrf_cookie_request(
             cookie = self._csrf_id_cookie
         if token_header is None:
             token_header = 'HTTP_X_CSRFTOKEN'
-        req = self._get_request(method=method, cookie=cookie)
+        req = self._get_request(
+            method=method,
+            cookie=cookie,
+            request_class=request_class,
+        )
         if post_token is not None:
             req.POST['csrfmiddlewaretoken'] = post_token
         if meta_token is not None:
@@ -165,15 +188,21 @@ def _get_csrf_cookie_request(
 
     def _get_POST_csrf_cookie_request(
         self, cookie=None, post_token=None, meta_token=None, token_header=None,
+        request_class=None,
     ):
         return self._get_csrf_cookie_request(
             method='POST', cookie=cookie, post_token=post_token,
             meta_token=meta_token, token_header=token_header,
+            request_class=request_class,
         )
 
-    def _get_POST_request_with_token(self, cookie=None):
+    def _get_POST_request_with_token(self, cookie=None, request_class=None):
         """The cookie argument defaults to this class's default test cookie."""
-        return self._get_POST_csrf_cookie_request(cookie=cookie, post_token=self._csrf_id_token)
+        return self._get_POST_csrf_cookie_request(
+            cookie=cookie,
+            post_token=self._csrf_id_token,
+            request_class=request_class,
+        )
 
     def _check_token_present(self, response, csrf_id=None):
         text = str(response.content, response.charset)
@@ -699,52 +728,19 @@ def test_ensures_csrf_cookie_no_logging(self):
             req = self._get_request()
             ensure_csrf_cookie_view(req)
 
-    def test_post_data_read_failure(self):
+    def test_reading_post_data_raises_unreadable_post_error(self):
         """
-        OSErrors during POST data reading are caught and treated as if the
-        POST data wasn't there (#20128).
+        An UnreadablePostError raised while reading the POST data should be
+        handled by the middleware.
         """
-        class CsrfPostRequest(HttpRequest):
-            """
-            HttpRequest that can raise an OSError when accessing POST data
-            """
-            def __init__(self, token, raise_error):
-                super().__init__()
-                self.method = 'POST'
-
-                self.raise_error = False
-                self.COOKIES[settings.CSRF_COOKIE_NAME] = token
-
-                # Handle both cases here to prevent duplicate code in the
-                # session tests.
-                self.session = {}
-                self.session[CSRF_SESSION_KEY] = token
-
-                self.POST['csrfmiddlewaretoken'] = token
-                self.raise_error = raise_error
-
-            def _load_post_and_files(self):
-                raise OSError('error reading input data')
-
-            def _get_post(self):
-                if self.raise_error:
-                    self._load_post_and_files()
-                return self._post
-
-            def _set_post(self, post):
-                self._post = post
-
-            POST = property(_get_post, _set_post)
-
-        token = ('ABC' + self._csrf_id_token)[:CSRF_TOKEN_LENGTH]
-
-        req = CsrfPostRequest(token, raise_error=False)
+        req = self._get_POST_request_with_token()
         mw = CsrfViewMiddleware(post_form_view)
         mw.process_request(req)
         resp = mw.process_view(req, post_form_view, (), {})
         self.assertIsNone(resp)
 
-        req = CsrfPostRequest(token, raise_error=True)
+        req = self._get_POST_request_with_token(request_class=PostErrorRequest)
+        req.post_error = UnreadablePostError('Error reading input data.')
         mw.process_request(req)
         with self.assertLogs('django.security.csrf', 'WARNING') as cm:
             resp = mw.process_view(req, post_form_view, (), {})
@@ -754,6 +750,18 @@ def _set_post(self, post):
             'Forbidden (%s): ' % REASON_CSRF_TOKEN_MISSING,
         )
 
+    def test_reading_post_data_raises_os_error(self):
+        """
+        An OSError raised while reading the POST data should not be handled by
+        the middleware.
+        """
+        mw = CsrfViewMiddleware(post_form_view)
+        req = self._get_POST_request_with_token(request_class=PostErrorRequest)
+        req.post_error = OSError('Deleted directories/Missing permissions.')
+        mw.process_request(req)
+        with self.assertRaises(OSError):
+            mw.process_view(req, post_form_view, (), {})
+
     @override_settings(ALLOWED_HOSTS=['www.example.com'])
     def test_bad_origin_bad_domain(self):
         """A request with a bad origin is rejected."""