# 修复代码生成提示词（实例ID：django__django-11911）
## 代码仓库
django/django

## 原始问题描述
"migrate --plan" outputs "IRREVERSIBLE" on RunPython operations without docstrings.
Description
	
Given a migration like:
from django.db import migrations
def forward(apps, schema_editor):
	pass
def reverse(apps, schema_editor):
	pass
class Migration(migrations.Migration):
	operations = [
		migrations.RunPython(forward, reverse)
	]
manage.py migrate --plan will output:
Planned operations:
example.0001_initial
	Raw Python operation -> IRREVERSIBLE
The migration should not be described as "irreversible".
This error is in the definition of describe_operation in django/django/core/management/commands/migrate.py, reproduced below with line numbers from 2.2.6 tag.
343	@staticmethod
344	def describe_operation(operation, backwards):
345		"""Return a string that describes a migration operation for --plan."""
346		prefix = ''
347		if hasattr(operation, 'code'):
348			code = operation.reverse_code if backwards else operation.code
349			action = code.__doc__ if code else ''
350		elif hasattr(operation, 'sql'):
351			action = operation.reverse_sql if backwards else operation.sql
352		else:
353			action = ''
354			if backwards:
355				prefix = 'Undo '
356		if action is None:
357			action = 'IRREVERSIBLE'
358			is_error = True
359		else:
360			action = str(action).replace('\n', '')
361			is_error = False
362		if action:
363			action = ' -> ' + action
364		truncated = Truncator(action)
365	return prefix + operation.describe() + truncated.chars(40), is_error
Line 349 uses the docstring as the output string.
Line 356 tests that value and sets action = 'IRREVERSIBLE' on line 357 because the dosctring is None.
It would appear that the intention is to use a docstring to describe the operation, if available, and leave it blank otherwise. However, because it tests against code instead of code.__doc__ it actually sets action = None resulting in 'IRREVERSIBLE' being displayed.
Proposed Solutions below
For a localized fix, I believe line 349 should be replaced by
		if code:
			action = code.__doc__ if code.__doc__ else ''
		else:
			action = None
However, a more holistic view suggests that displaying "IRREVERSIBLE" isn't really the correct thing to do. "IRREVERSIBLE" is set when is_error is also set to True and seems to be trying to indicate that the migration operation is invalid rather than irreversible. That is, if code/reverse_code is None (line 348) or sql/reverse_sql is None (line 351) the migration can't run.
Since sql and code are required parameters for their respective Operations, action should only possibly be None in the reverse case, which seems to be what this code is trying to capture and explain.
Given that, a better approach would probably make use of the reversible property defined on RunSQL and RunPython operations. This is a little verbose and could probably be pared down, but I think it has the right logic:
@staticmethod
def describe_operation(operation, backwards):
	"""Return a string that describes a migration operation for --plan."""
	prefix = ''
	action = ''
	is_error = False
	if backwards:
		prefix = 'Undo '
		if hasattr(operation, 'reversible') and not operation.reversible:
			action = 'INVALID'
			is_error = True
		elif hasattr(operation, 'reverse_code'):
			action = operation.reverse_code.__doc__ if operation.reverse_code.__doc__ else ''
		elif hasattr(operation, 'reverse_sql'):
			action = operation.reverse_sql.__doc__ if operation.reverse_sql.__doc__ else ''
	else:
		if hasattr(operation, 'code'):
			action = operation.code.__doc__ if operation.code.__doc__ else ''
		elif hasattr(operation, 'sql'):
			action = operation.sql.__doc__ if operation.sql.__doc__ else ''
	action = ' -> ' + str(action).replace('\n', '')
	truncated = Truncator(action)
	return prefix + operation.describe() + truncated.chars(40), is_error


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/migrations/test_commands.py b/tests/migrations/test_commands.py
--- a/tests/migrations/test_commands.py
+++ b/tests/migrations/test_commands.py
@@ -327,53 +327,77 @@ def test_migrate_plan(self):
             "    Raw SQL operation -> ['SELECT * FROM migrations_author']\n",
             out.getvalue()
         )
-        # Migrate to the third migration.
-        call_command('migrate', 'migrations', '0003', verbosity=0)
-        out = io.StringIO()
-        # Show the plan for when there is nothing to apply.
-        call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
-        self.assertEqual(
-            'Planned operations:\n'
-            '  No planned migration operations.\n',
-            out.getvalue()
-        )
-        out = io.StringIO()
-        # Show the plan for reverse migration back to 0001.
-        call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
-        self.assertEqual(
-            'Planned operations:\n'
-            'migrations.0003_third\n'
-            '    Undo Create model Author\n'
-            "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
-            'migrations.0002_second\n'
-            '    Undo Create model Book\n'
-            "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
-            out.getvalue()
-        )
-        out = io.StringIO()
-        # Show the migration plan to fourth, with truncated details.
-        call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
-        self.assertEqual(
-            'Planned operations:\n'
-            'migrations.0004_fourth\n'
-            '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
-            out.getvalue()
-        )
-        # Show the plan when an operation is irreversible.
-        # Migrate to the fourth migration.
-        call_command('migrate', 'migrations', '0004', verbosity=0)
-        out = io.StringIO()
-        call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
-        self.assertEqual(
-            'Planned operations:\n'
-            'migrations.0004_fourth\n'
-            '    Raw SQL operation -> IRREVERSIBLE\n',
-            out.getvalue()
-        )
-        # Cleanup by unmigrating everything: fake the irreversible, then
-        # migrate all to zero.
-        call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
-        call_command('migrate', 'migrations', 'zero', verbosity=0)
+        try:
+            # Migrate to the third migration.
+            call_command('migrate', 'migrations', '0003', verbosity=0)
+            out = io.StringIO()
+            # Show the plan for when there is nothing to apply.
+            call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
+            self.assertEqual(
+                'Planned operations:\n'
+                '  No planned migration operations.\n',
+                out.getvalue()
+            )
+            out = io.StringIO()
+            # Show the plan for reverse migration back to 0001.
+            call_command('migrate', 'migrations', '0001', plan=True, stdout=out, no_color=True)
+            self.assertEqual(
+                'Planned operations:\n'
+                'migrations.0003_third\n'
+                '    Undo Create model Author\n'
+                "    Raw SQL operation -> ['SELECT * FROM migrations_book']\n"
+                'migrations.0002_second\n'
+                '    Undo Create model Book\n'
+                "    Raw SQL operation -> ['SELECT * FROM migrations_salamand…\n",
+                out.getvalue()
+            )
+            out = io.StringIO()
+            # Show the migration plan to fourth, with truncated details.
+            call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
+            self.assertEqual(
+                'Planned operations:\n'
+                'migrations.0004_fourth\n'
+                '    Raw SQL operation -> SELECT * FROM migrations_author WHE…\n',
+                out.getvalue()
+            )
+            # Show the plan when an operation is irreversible.
+            # Migrate to the fourth migration.
+            call_command('migrate', 'migrations', '0004', verbosity=0)
+            out = io.StringIO()
+            call_command('migrate', 'migrations', '0003', plan=True, stdout=out, no_color=True)
+            self.assertEqual(
+                'Planned operations:\n'
+                'migrations.0004_fourth\n'
+                '    Raw SQL operation -> IRREVERSIBLE\n',
+                out.getvalue()
+            )
+            out = io.StringIO()
+            call_command('migrate', 'migrations', '0005', plan=True, stdout=out, no_color=True)
+            # Operation is marked as irreversible only in the revert plan.
+            self.assertEqual(
+                'Planned operations:\n'
+                'migrations.0005_fifth\n'
+                '    Raw Python operation\n'
+                '    Raw Python operation\n'
+                '    Raw Python operation -> Feed salamander.\n',
+                out.getvalue()
+            )
+            call_command('migrate', 'migrations', '0005', verbosity=0)
+            out = io.StringIO()
+            call_command('migrate', 'migrations', '0004', plan=True, stdout=out, no_color=True)
+            self.assertEqual(
+                'Planned operations:\n'
+                'migrations.0005_fifth\n'
+                '    Raw Python operation -> IRREVERSIBLE\n'
+                '    Raw Python operation -> IRREVERSIBLE\n'
+                '    Raw Python operation\n',
+                out.getvalue()
+            )
+        finally:
+            # Cleanup by unmigrating everything: fake the irreversible, then
+            # migrate all to zero.
+            call_command('migrate', 'migrations', '0003', fake=True, verbosity=0)
+            call_command('migrate', 'migrations', 'zero', verbosity=0)
 
     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations_empty'})
     def test_showmigrations_no_migrations(self):
diff --git a/tests/migrations/test_migrations_plan/0005_fifth.py b/tests/migrations/test_migrations_plan/0005_fifth.py
new file mode 100644
--- /dev/null
+++ b/tests/migrations/test_migrations_plan/0005_fifth.py
@@ -0,0 +1,22 @@
+from django.db import migrations
+
+
+def grow_tail(x, y):
+    pass
+
+
+def feed(x, y):
+    """Feed salamander."""
+    pass
+
+
+class Migration(migrations.Migration):
+    dependencies = [
+        ('migrations', '0004_fourth'),
+    ]
+
+    operations = [
+        migrations.RunPython(migrations.RunPython.noop),
+        migrations.RunPython(grow_tail),
+        migrations.RunPython(feed, migrations.RunPython.noop),
+    ]