# 修复代码生成提示词（实例ID：django__django-13952）
## 代码仓库
django/django

## 原始问题描述
Migrate signals verbose stdout emissions are not capturable
Description
	
The migrate command takes a --verbosity flag that is passed down to emit_pre_migrate_signal and emit_post_migrate_signal functions but these are not provided which stdout the output should be directed to. This makes testing migrate -v2 through call_command pollute sys.stdout when it should be directed to the provided stdout as discovered in ​https://github.com/django/django/pull/13890#pullrequestreview-579320176


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/migrate_signals/tests.py b/tests/migrate_signals/tests.py
--- a/tests/migrate_signals/tests.py
+++ b/tests/migrate_signals/tests.py
@@ -1,3 +1,5 @@
+from io import StringIO
+
 from django.apps import apps
 from django.core import management
 from django.db import migrations
@@ -5,7 +7,7 @@
 from django.test import TransactionTestCase, override_settings
 
 APP_CONFIG = apps.get_app_config('migrate_signals')
-SIGNAL_ARGS = ['app_config', 'verbosity', 'interactive', 'using', 'plan', 'apps']
+SIGNAL_ARGS = ['app_config', 'verbosity', 'interactive', 'using', 'stdout', 'plan', 'apps']
 MIGRATE_DATABASE = 'default'
 MIGRATE_VERBOSITY = 0
 MIGRATE_INTERACTIVE = False
@@ -69,19 +71,21 @@ def test_args(self):
         post_migrate_receiver = Receiver(signals.post_migrate)
         management.call_command(
             'migrate', database=MIGRATE_DATABASE, verbosity=MIGRATE_VERBOSITY,
-            interactive=MIGRATE_INTERACTIVE,
+            interactive=MIGRATE_INTERACTIVE, stdout=StringIO('test_args'),
         )
 
         for receiver in [pre_migrate_receiver, post_migrate_receiver]:
-            args = receiver.call_args
-            self.assertEqual(receiver.call_counter, 1)
-            self.assertEqual(set(args), set(SIGNAL_ARGS))
-            self.assertEqual(args['app_config'], APP_CONFIG)
-            self.assertEqual(args['verbosity'], MIGRATE_VERBOSITY)
-            self.assertEqual(args['interactive'], MIGRATE_INTERACTIVE)
-            self.assertEqual(args['using'], 'default')
-            self.assertEqual(args['plan'], [])
-            self.assertIsInstance(args['apps'], migrations.state.StateApps)
+            with self.subTest(receiver=receiver):
+                args = receiver.call_args
+                self.assertEqual(receiver.call_counter, 1)
+                self.assertEqual(set(args), set(SIGNAL_ARGS))
+                self.assertEqual(args['app_config'], APP_CONFIG)
+                self.assertEqual(args['verbosity'], MIGRATE_VERBOSITY)
+                self.assertEqual(args['interactive'], MIGRATE_INTERACTIVE)
+                self.assertEqual(args['using'], 'default')
+                self.assertIn('test_args', args['stdout'].getvalue())
+                self.assertEqual(args['plan'], [])
+                self.assertIsInstance(args['apps'], migrations.state.StateApps)
 
     @override_settings(MIGRATION_MODULES={'migrate_signals': 'migrate_signals.custom_migrations'})
     def test_migrations_only(self):
diff --git a/tests/migrations/test_commands.py b/tests/migrations/test_commands.py
--- a/tests/migrations/test_commands.py
+++ b/tests/migrations/test_commands.py
@@ -39,10 +39,12 @@ def test_migrate(self):
         self.assertTableNotExists("migrations_book")
         # Run the migrations to 0001 only
         stdout = io.StringIO()
-        call_command('migrate', 'migrations', '0001', verbosity=1, stdout=stdout, no_color=True)
+        call_command('migrate', 'migrations', '0001', verbosity=2, stdout=stdout, no_color=True)
         stdout = stdout.getvalue()
         self.assertIn('Target specific migration: 0001_initial, from migrations', stdout)
         self.assertIn('Applying migrations.0001_initial... OK', stdout)
+        self.assertIn('Running pre-migrate handlers for application migrations', stdout)
+        self.assertIn('Running post-migrate handlers for application migrations', stdout)
         # The correct tables exist
         self.assertTableExists("migrations_author")
         self.assertTableExists("migrations_tribble")
@@ -55,10 +57,12 @@ def test_migrate(self):
         self.assertTableExists("migrations_book")
         # Unmigrate everything
         stdout = io.StringIO()
-        call_command('migrate', 'migrations', 'zero', verbosity=1, stdout=stdout, no_color=True)
+        call_command('migrate', 'migrations', 'zero', verbosity=2, stdout=stdout, no_color=True)
         stdout = stdout.getvalue()
         self.assertIn('Unapply all migrations: migrations', stdout)
         self.assertIn('Unapplying migrations.0002_second... OK', stdout)
+        self.assertIn('Running pre-migrate handlers for application migrations', stdout)
+        self.assertIn('Running post-migrate handlers for application migrations', stdout)
         # Tables are gone
         self.assertTableNotExists("migrations_author")
         self.assertTableNotExists("migrations_tribble")