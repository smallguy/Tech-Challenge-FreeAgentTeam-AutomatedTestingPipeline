# 修复代码生成提示词（实例ID：pytest-dev__pytest-5205）
## 代码仓库
pytest-dev/pytest

## 原始问题描述
Invalid XML schema for <properties> tags in JUnit reports 
The problem:

JUnit breaks when it reads an XML generated by pytest if plugins make use of  `record-property`. This behavior happens with newer versions of  hypothesis (https://github.com/HypothesisWorks/hypothesis/issues/1935).

```
[xUnit] [ERROR] - The result file '/somewhere/tests/pytests.xml' for the metric 'JUnit' is not valid. The result file has been skipped.
```

In fact, as already mentioned in https://github.com/pytest-dev/pytest/issues/1126#issuecomment-484581283,  `record-property` is adding `<properties>` inside `<testcase>` which seems to be wrong (it should be inside `<testsuite>`). See: https://github.com/windyroad/JUnit-Schema/blob/master/JUnit.xsd .

It happens with all junit families.

Reproducing:

```
$ pip list
Package        Version 
-------------- --------
apipkg         1.5     
atomicwrites   1.3.0   
attrs          19.1.0  
certifi        2019.3.9
execnet        1.6.0   
hypothesis     4.18.3  
more-itertools 4.3.0   
pip            19.1    
pluggy         0.9.0   
py             1.8.0   
pytest         4.4.1   
pytest-forked  1.0.2   
pytest-xdist   1.28.0  
setuptools     41.0.1  
six            1.12.0  
wheel          0.33.1 
```

`test_xml_generation.py`
```
from hypothesis import given, strategies


@given(x=strategies.integers(1, 10,))
def test_xml_generation(x):
    assert 1 <= x <= 10
```

```
$ pytest --junitxml=report.xml
```

`report.xml`
```
<?xml version="1.0" encoding="utf-8"?>
<testsuite errors="0" failures="0" name="pytest" skipped="0" tests="1" time="0.211">
    <testcase classname="test_xml_generation" file="test_xml_generation.py" line="3" name="test_xml_generation"
              time="0.074">
        <properties>
            <property name="hypothesis-stats"
                      value="[&apos;test_xml_generation.py::test_xml_generation:&apos;, &apos;&apos;, &apos;  - 100 passing examples, 0 failing examples, 0 invalid examples&apos;, &apos;  - Typical runtimes: &lt; 1ms&apos;, &apos;  - Fraction of time spent in data generation: ~ 49%&apos;, &apos;  - Stopped because settings.max_examples=100&apos;, &apos;&apos;]"/>
        </properties>
    </testcase>
</testsuite>
```

I was trying to create a PR to fix this, but when I saw https://github.com/pytest-dev/pytest/blob/7dcd9bf5add337686ec6f2ee81b24e8424319dba/src/_pytest/junitxml.py code I realized that what is needed to do could have more implications that I though. I think that nobody uses this feature with JUnit (as it breaks) and removing that is something to think about.




## 参考黄金补丁（正确的修复方案）
diff --git a/testing/test_junitxml.py b/testing/test_junitxml.py
--- a/testing/test_junitxml.py
+++ b/testing/test_junitxml.py
@@ -1243,6 +1243,53 @@ class Report(BaseReport):
     ), "The URL did not get written to the xml"
 
 
+def test_record_testsuite_property(testdir):
+    testdir.makepyfile(
+        """
+        def test_func1(record_testsuite_property):
+            record_testsuite_property("stats", "all good")
+
+        def test_func2(record_testsuite_property):
+            record_testsuite_property("stats", 10)
+    """
+    )
+    result, dom = runandparse(testdir)
+    assert result.ret == 0
+    node = dom.find_first_by_tag("testsuite")
+    properties_node = node.find_first_by_tag("properties")
+    p1_node = properties_node.find_nth_by_tag("property", 0)
+    p2_node = properties_node.find_nth_by_tag("property", 1)
+    p1_node.assert_attr(name="stats", value="all good")
+    p2_node.assert_attr(name="stats", value="10")
+
+
+def test_record_testsuite_property_junit_disabled(testdir):
+    testdir.makepyfile(
+        """
+        def test_func1(record_testsuite_property):
+            record_testsuite_property("stats", "all good")
+    """
+    )
+    result = testdir.runpytest()
+    assert result.ret == 0
+
+
+@pytest.mark.parametrize("junit", [True, False])
+def test_record_testsuite_property_type_checking(testdir, junit):
+    testdir.makepyfile(
+        """
+        def test_func1(record_testsuite_property):
+            record_testsuite_property(1, 2)
+    """
+    )
+    args = ("--junitxml=tests.xml",) if junit else ()
+    result = testdir.runpytest(*args)
+    assert result.ret == 1
+    result.stdout.fnmatch_lines(
+        ["*TypeError: name parameter needs to be a string, but int given"]
+    )
+
+
 @pytest.mark.parametrize("suite_name", ["my_suite", ""])
 def test_set_suite_name(testdir, suite_name):
     if suite_name: