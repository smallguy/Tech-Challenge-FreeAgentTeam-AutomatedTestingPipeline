# 修复代码生成提示词（实例ID：django__django-13301）
## 代码仓库
django/django

## 原始问题描述
Default username in createsuperuser command doesn't respect the --database option.
Description
	
The createsuperuser command in interactive mode suggests to leave username blank and use the default name (django.contrib.auth.management.get_default_username). The default name is validated to not be already used by an another user. This validation executes a query on User model using default database and not using the database option passed to the command.
This is the problem when you are using multiple databases.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/auth_tests/test_management.py b/tests/auth_tests/test_management.py
--- a/tests/auth_tests/test_management.py
+++ b/tests/auth_tests/test_management.py
@@ -102,6 +102,7 @@ def test_input_not_found(self):
 
 
 class GetDefaultUsernameTestCase(TestCase):
+    databases = {'default', 'other'}
 
     def setUp(self):
         self.old_get_system_username = management.get_system_username
@@ -128,6 +129,15 @@ def test_i18n(self):
         management.get_system_username = lambda: 'J\xfalia'
         self.assertEqual(management.get_default_username(), 'julia')
 
+    def test_with_database(self):
+        User.objects.create(username='joe')
+        management.get_system_username = lambda: 'joe'
+        self.assertEqual(management.get_default_username(), '')
+        self.assertEqual(management.get_default_username(database='other'), 'joe')
+
+        User.objects.using('other').create(username='joe')
+        self.assertEqual(management.get_default_username(database='other'), '')
+
 
 @override_settings(AUTH_PASSWORD_VALIDATORS=[
     {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
@@ -1031,7 +1041,7 @@ class MultiDBCreatesuperuserTestCase(TestCase):
 
     def test_createsuperuser_command_with_database_option(self):
         """
-        changepassword --database should operate on the specified DB.
+        createsuperuser --database should operate on the specified DB.
         """
         new_io = StringIO()
         call_command(
@@ -1047,6 +1057,36 @@ def test_createsuperuser_command_with_database_option(self):
         user = User.objects.using('other').get(username='joe')
         self.assertEqual(user.email, 'joe@somewhere.org')
 
+    def test_createsuperuser_command_suggested_username_with_database_option(self):
+        default_username = get_default_username(database='other')
+        qs = User.objects.using('other')
+
+        @mock_inputs({'password': 'nopasswd', 'username': '', 'email': ''})
+        def test_other_create_with_suggested_username(self):
+            call_command(
+                'createsuperuser',
+                interactive=True,
+                stdin=MockTTY(),
+                verbosity=0,
+                database='other',
+            )
+            self.assertIs(qs.filter(username=default_username).exists(), True)
+
+        test_other_create_with_suggested_username(self)
+
+        @mock_inputs({'password': 'nopasswd', 'Username: ': 'other', 'email': ''})
+        def test_other_no_suggestion(self):
+            call_command(
+                'createsuperuser',
+                interactive=True,
+                stdin=MockTTY(),
+                verbosity=0,
+                database='other',
+            )
+            self.assertIs(qs.filter(username='other').exists(), True)
+
+        test_other_no_suggestion(self)
+
 
 class CreatePermissionsTests(TestCase):