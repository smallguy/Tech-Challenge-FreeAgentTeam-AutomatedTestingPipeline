# 修复代码生成提示词（实例ID：django__django-13085）
## 代码仓库
django/django

## 原始问题描述
compilemessages needlessly runs msgfmt on unchanged .po files
Description
	
I have a project where running django-admin compilemessages takes 1.75 seconds. Running it again, when all the .mo files already exists and are up-to-date, also takes 1.75 seconds.
I propose that compilemessages.py is changed so that it only invokes msgfmt when it would do anything useful. This can be implemented by checking the mtime of the .po file and the corresponding .mo file. (If statting the .mo file fails, treat that as if the mtime was 0.) Only submit the command to the executor if the mtime of the .po file is greater than that of the .mo file. In effect: don't do anything if the .mo file is newer than the .po file.
There is one issue with this: the way the code currently uses the is_writable function. Since it modifies the mtime of the .mo file, you would have to perform the stat of the .mo file before you check if it is writable. (Or, you could just remove the is_writable function and its use. That feature is, in my opinion, of dubious value, and it doesn't appear to be documented.)
After I made the changes above, the runtime in the common case where nothing needs to be done was reduced from 1.75 seconds to 0.2 seconds.
(Unfortunately, I doubt that I will be able to get a Corporate Contributor License Agreement signed, so I can unfortunately not contribute my change.)
1.75 seconds may not be much, but when a CI system does it repeatedly, it adds up.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/i18n/test_compilation.py b/tests/i18n/test_compilation.py
--- a/tests/i18n/test_compilation.py
+++ b/tests/i18n/test_compilation.py
@@ -34,6 +34,7 @@ class PoFileTests(MessageCompilationTests):
 
     LOCALE = 'es_AR'
     MO_FILE = 'locale/%s/LC_MESSAGES/django.mo' % LOCALE
+    MO_FILE_EN = 'locale/en/LC_MESSAGES/django.mo'
 
     def test_bom_rejection(self):
         stderr = StringIO()
@@ -43,17 +44,27 @@ def test_bom_rejection(self):
         self.assertFalse(os.path.exists(self.MO_FILE))
 
     def test_no_write_access(self):
-        mo_file_en = 'locale/en/LC_MESSAGES/django.mo'
+        mo_file_en = Path(self.MO_FILE_EN)
         err_buffer = StringIO()
-        # put file in read-only mode
-        old_mode = os.stat(mo_file_en).st_mode
-        os.chmod(mo_file_en, stat.S_IREAD)
+        # Put file in read-only mode.
+        old_mode = mo_file_en.stat().st_mode
+        mo_file_en.chmod(stat.S_IREAD)
+        # Ensure .po file is more recent than .mo file.
+        mo_file_en.with_suffix('.po').touch()
         try:
             with self.assertRaisesMessage(CommandError, 'compilemessages generated one or more errors.'):
                 call_command('compilemessages', locale=['en'], stderr=err_buffer, verbosity=0)
             self.assertIn('not writable location', err_buffer.getvalue())
         finally:
-            os.chmod(mo_file_en, old_mode)
+            mo_file_en.chmod(old_mode)
+
+    def test_no_compile_when_unneeded(self):
+        mo_file_en = Path(self.MO_FILE_EN)
+        mo_file_en.touch()
+        stdout = StringIO()
+        call_command('compilemessages', locale=['en'], stdout=stdout, verbosity=1)
+        msg = '%s” is already compiled and up to date.' % mo_file_en.with_suffix('.po')
+        self.assertIn(msg, stdout.getvalue())
 
 
 class PoFileContentsTests(MessageCompilationTests):