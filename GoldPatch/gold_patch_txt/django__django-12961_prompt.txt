# 修复代码生成提示词（实例ID：django__django-12961）
## 代码仓库
django/django

## 原始问题描述
order_by() with expressions crashes on union() querysets.
Description
	 
		(last modified by Mariusz Felisiak)
	 
I have read the recent tickets about unions and order_by (#31496, #27995, #30628) , and my bug is slightly different, so I hope it's not a duplicate. 
Let's consider two similar models: 
class EntityA(models.Model):
	name_a = models.CharField(max_length=128, null=True)
	dt_a = models.DateTimeField(null=True)
class EntityB(models.Model):
	name_b = models.CharField(max_length=128, null=True)
	dt_b = models.DateTimeField(null=True)
EntityA.objects.create(name_a="a")
EntityA.objects.create(name_a="qwerty", dt_a=timezone.now())
EntityB.objects.create(name_b="random", dt_b=timezone.now())
EntityB.objects.create(name_b="b")
qs_a = EntityA.objects.values(name=F("name_a"), dt=F("dt_a"))
qs_b = EntityB.objects.values(name=F("name_b"), dt=F("dt_b"))
# union queryset
queryset = qs_a.union(qs_b)
I can use a simple ORDER BY clause:
queryset.order_by("-dt")
And everything will work, no problem here.
What I actually want is the same query, but with a NULLS LAST
Usually the query becomes: 
queryset.order_by(F("dt").desc(nulls_last=True)) 
but that raises a 
DatabaseError: ORDER BY term does not match any column in the result set.
I know unions can handle only a few clauses, but ORDER BY is one of them, so I'm unsure whether this is the expected behaviour or not. 
If it's expected, then the raised exception could be more explicit.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/queries/test_qs_combinators.py b/tests/queries/test_qs_combinators.py
--- a/tests/queries/test_qs_combinators.py
+++ b/tests/queries/test_qs_combinators.py
@@ -1,3 +1,5 @@
+import operator
+
 from django.db import DatabaseError, NotSupportedError, connection
 from django.db.models import Exists, F, IntegerField, OuterRef, Value
 from django.test import TestCase, skipIfDBFeature, skipUnlessDBFeature
@@ -11,11 +13,8 @@ class QuerySetSetOperationTests(TestCase):
     def setUpTestData(cls):
         Number.objects.bulk_create(Number(num=i, other_num=10 - i) for i in range(10))
 
-    def number_transform(self, value):
-        return value.num
-
     def assertNumbersEqual(self, queryset, expected_numbers, ordered=True):
-        self.assertQuerysetEqual(queryset, expected_numbers, self.number_transform, ordered)
+        self.assertQuerysetEqual(queryset, expected_numbers, operator.attrgetter('num'), ordered)
 
     def test_simple_union(self):
         qs1 = Number.objects.filter(num__lte=1)
@@ -110,11 +109,35 @@ def test_ordering(self):
         qs2 = Number.objects.filter(num__gte=2, num__lte=3)
         self.assertNumbersEqual(qs1.union(qs2).order_by('-num'), [3, 2, 1, 0])
 
+    def test_ordering_by_alias(self):
+        qs1 = Number.objects.filter(num__lte=1).values(alias=F('num'))
+        qs2 = Number.objects.filter(num__gte=2, num__lte=3).values(alias=F('num'))
+        self.assertQuerysetEqual(
+            qs1.union(qs2).order_by('-alias'),
+            [3, 2, 1, 0],
+            operator.itemgetter('alias'),
+        )
+
     def test_ordering_by_f_expression(self):
         qs1 = Number.objects.filter(num__lte=1)
         qs2 = Number.objects.filter(num__gte=2, num__lte=3)
         self.assertNumbersEqual(qs1.union(qs2).order_by(F('num').desc()), [3, 2, 1, 0])
 
+    def test_ordering_by_f_expression_and_alias(self):
+        qs1 = Number.objects.filter(num__lte=1).values(alias=F('other_num'))
+        qs2 = Number.objects.filter(num__gte=2, num__lte=3).values(alias=F('other_num'))
+        self.assertQuerysetEqual(
+            qs1.union(qs2).order_by(F('alias').desc()),
+            [10, 9, 8, 7],
+            operator.itemgetter('alias'),
+        )
+        Number.objects.create(num=-1)
+        self.assertQuerysetEqual(
+            qs1.union(qs2).order_by(F('alias').desc(nulls_last=True)),
+            [10, 9, 8, 7, None],
+            operator.itemgetter('alias'),
+        )
+
     def test_union_with_values(self):
         ReservedName.objects.create(name='a', order=2)
         qs1 = ReservedName.objects.all()
@@ -243,6 +266,8 @@ def test_order_raises_on_non_selected_column(self):
         # 'num' got realiased to num2
         with self.assertRaisesMessage(DatabaseError, msg):
             list(qs1.union(qs2).order_by('num'))
+        with self.assertRaisesMessage(DatabaseError, msg):
+            list(qs1.union(qs2).order_by(F('num')))
         # switched order, now 'exists' again:
         list(qs2.union(qs1).order_by('num'))