# 修复代码生成提示词（实例ID：django__django-13287）
## 代码仓库
django/django

## 原始问题描述
App with default_app_config and without apps.py or with an empty apps.py crashes.
Description
	 
		(last modified by Iuri de Silvio)
	 
If I don't have an apps.py and the default_app_config is in __init__.py, it fails.
Traceback (most recent call last):
 File "./manage.py", line 22, in <module>
	main()
 File "./manage.py", line 18, in main
	execute_from_command_line(sys.argv)
 File "django/core/management/__init__.py", line 401, in execute_from_command_line
	utility.execute()
 File "django/core/management/__init__.py", line 377, in execute
	django.setup()
 File "django/__init__.py", line 24, in setup
	apps.populate(settings.INSTALLED_APPS)
 File "django/apps/registry.py", line 91, in populate
	app_config = AppConfig.create(entry)
 File "django/apps/config.py", line 157, in create
	if new_entry == app_config_name:
UnboundLocalError: local variable 'app_config_name' referenced before assignment
If the apps.py is there, but the default_app_config is in __init__.py, it fails too.
Traceback (most recent call last):
 File "django/django/test/utils.py", line 381, in inner
	return func(*args, **kwargs)
 File "django/tests/apps/tests.py", line 541, in test_explicit_default_app_config_with_empty_apps
	with self.settings(INSTALLED_APPS=['apps.explicit_default_config_with_empty_apps']):
 File "django/django/test/utils.py", line 336, in __enter__
	return self.enable()
 File "django/django/test/utils.py", line 410, in enable
	apps.set_installed_apps(self.options['INSTALLED_APPS'])
 File "django/django/apps/registry.py", line 355, in set_installed_apps
	self.populate(installed)
 File "django/django/apps/registry.py", line 91, in populate
	app_config = AppConfig.create(entry)
 File "django/django/apps/config.py", line 160, in create
	if new_entry == app_config_name:
UnboundLocalError: local variable 'app_config_name' referenced before assignment
Looks like a regression added in https://code.djangoproject.com/ticket/31180.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/apps/explicit_default_config_empty_apps/__init__.py b/tests/apps/explicit_default_config_empty_apps/__init__.py
new file mode 100644
--- /dev/null
+++ b/tests/apps/explicit_default_config_empty_apps/__init__.py
@@ -0,0 +1,7 @@
+from django.apps import AppConfig
+
+default_app_config = 'apps.explicit_default_config_empty_apps.ExplicitDefaultConfigEmptyApps'
+
+
+class ExplicitDefaultConfigEmptyApps(AppConfig):
+    name = 'apps.explicit_default_config_empty_apps'
diff --git a/tests/apps/explicit_default_config_empty_apps/apps.py b/tests/apps/explicit_default_config_empty_apps/apps.py
new file mode 100644
diff --git a/tests/apps/explicit_default_config_without_apps/__init__.py b/tests/apps/explicit_default_config_without_apps/__init__.py
new file mode 100644
--- /dev/null
+++ b/tests/apps/explicit_default_config_without_apps/__init__.py
@@ -0,0 +1,7 @@
+from django.apps import AppConfig
+
+default_app_config = 'apps.explicit_default_config_without_apps.ExplicitDefaultConfigWithoutApps'
+
+
+class ExplicitDefaultConfigWithoutApps(AppConfig):
+    name = 'apps.explicit_default_config_without_apps'
diff --git a/tests/apps/tests.py b/tests/apps/tests.py
--- a/tests/apps/tests.py
+++ b/tests/apps/tests.py
@@ -10,9 +10,13 @@
 from django.utils.deprecation import RemovedInDjango41Warning
 
 from .explicit_default_config_app.apps import ExplicitDefaultConfig
+from .explicit_default_config_empty_apps import ExplicitDefaultConfigEmptyApps
 from .explicit_default_config_mismatch_app.not_apps import (
     ExplicitDefaultConfigMismatch,
 )
+from .explicit_default_config_without_apps import (
+    ExplicitDefaultConfigWithoutApps,
+)
 from .models import SoAlternative, TotallyNormal, new_apps
 from .one_config_app.apps import OneConfig
 from .two_configs_one_default_app.apps import TwoConfig
@@ -520,3 +524,51 @@ def test_explicit_default_app_config_mismatch(self):
             with self.settings(INSTALLED_APPS=['apps.explicit_default_config_mismatch_app']):
                 config = apps.get_app_config('explicit_default_config_mismatch_app')
             self.assertIsInstance(config, ExplicitDefaultConfigMismatch)
+
+    def test_explicit_default_app_config_empty_apps(self):
+        """
+        Load an app that specifies a default AppConfig class in __init__ and
+        have an empty apps module.
+        """
+        msg = (
+            "'apps.explicit_default_config_empty_apps' defines "
+            "default_app_config = 'apps.explicit_default_config_empty_apps."
+            "ExplicitDefaultConfigEmptyApps'. However, Django's automatic "
+            "detection did not find this configuration. You should move the "
+            "default config class to the apps submodule of your application "
+            "and, if this module defines several config classes, mark the "
+            "default one with default = True."
+        )
+        with self.assertRaisesMessage(RemovedInDjango41Warning, msg):
+            with self.settings(INSTALLED_APPS=['apps.explicit_default_config_empty_apps']):
+                pass
+        with ignore_warnings(category=RemovedInDjango41Warning):
+            with self.settings(INSTALLED_APPS=['apps.explicit_default_config_empty_apps']):
+                self.assertIsInstance(
+                    apps.get_app_config('explicit_default_config_empty_apps'),
+                    ExplicitDefaultConfigEmptyApps,
+                )
+
+    def test_explicit_default_app_config_without_apps(self):
+        """
+        Load an app that specifies a default AppConfig class in __init__ and do
+        not have an apps module.
+        """
+        msg = (
+            "'apps.explicit_default_config_without_apps' defines "
+            "default_app_config = 'apps.explicit_default_config_without_apps."
+            "ExplicitDefaultConfigWithoutApps'. However, Django's automatic "
+            "detection did not find this configuration. You should move the "
+            "default config class to the apps submodule of your application "
+            "and, if this module defines several config classes, mark the "
+            "default one with default = True."
+        )
+        with self.assertRaisesMessage(RemovedInDjango41Warning, msg):
+            with self.settings(INSTALLED_APPS=['apps.explicit_default_config_without_apps']):
+                pass
+        with ignore_warnings(category=RemovedInDjango41Warning):
+            with self.settings(INSTALLED_APPS=['apps.explicit_default_config_without_apps']):
+                self.assertIsInstance(
+                    apps.get_app_config('explicit_default_config_without_apps'),
+                    ExplicitDefaultConfigWithoutApps,
+                )