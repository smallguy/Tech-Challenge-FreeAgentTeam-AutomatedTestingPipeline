# 修复代码生成提示词（实例ID：django__django-13665）
## 代码仓库
django/django

## 原始问题描述
Dabase creation backend should use base_manager to serialize database
Description
	
models.py
class Service(Model):
	objects = CustomManagerThatFillterOutSomeRecords()
class CustomManagerThatFillterOutSomeRecords(Manager):
	def get_queryset(self):
		return super().get_queryset().exclude(pk=1)
tests.py
class TestService(TransactionTestCase):
	serialized_rollback = True
	def test_something(self):
		pass
Assume we have a migration that creates few records of Service.
from django.core.management import call_command
from django.db import migrations
def load_fixtures(*_, **__):
	call_command('loaddata', 'services.json')
class Migration(migrations.Migration):
	dependencies = []
	operations = [
		migrations.RunPython(
			load_fixtures,
			migrations.RunPython.noop,
		)
	]
Then TestService will fail as serialize_db_to_string by default use _default_manager that is CustomManagerThatFillterOutSomeRecords.
Here is proposed fix: ​https://github.com/django/django/pull/13150


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/backends/base/test_creation.py b/tests/backends/base/test_creation.py
--- a/tests/backends/base/test_creation.py
+++ b/tests/backends/base/test_creation.py
@@ -1,4 +1,5 @@
 import copy
+import datetime
 from unittest import mock
 
 from django.db import DEFAULT_DB_ALIAS, connection, connections
@@ -10,6 +11,7 @@
 
 from ..models import (
     CircularA, CircularB, Object, ObjectReference, ObjectSelfReference,
+    SchoolClass,
 )
 
 
@@ -175,3 +177,14 @@ def test_circular_reference_with_natural_key(self):
         obj_b = CircularB.objects.get()
         self.assertEqual(obj_a.obj, obj_b)
         self.assertEqual(obj_b.obj, obj_a)
+
+    def test_serialize_db_to_string_base_manager(self):
+        SchoolClass.objects.create(year=1000, last_updated=datetime.datetime.now())
+        with mock.patch('django.db.migrations.loader.MigrationLoader') as loader:
+            # serialize_db_to_string() serializes only migrated apps, so mark
+            # the backends app as migrated.
+            loader_instance = loader.return_value
+            loader_instance.migrated_apps = {'backends'}
+            data = connection.creation.serialize_db_to_string()
+        self.assertIn('"model": "backends.schoolclass"', data)
+        self.assertIn('"year": 1000', data)
diff --git a/tests/backends/models.py b/tests/backends/models.py
--- a/tests/backends/models.py
+++ b/tests/backends/models.py
@@ -21,11 +21,18 @@ def __str__(self):
         return '%s %s' % (self.first_name, self.last_name)
 
 
+class SchoolClassManager(models.Manager):
+    def get_queryset(self):
+        return super().get_queryset().exclude(year=1000)
+
+
 class SchoolClass(models.Model):
     year = models.PositiveIntegerField()
     day = models.CharField(max_length=9, blank=True)
     last_updated = models.DateTimeField()
 
+    objects = SchoolClassManager()
+
 
 class VeryLongModelNameZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ(models.Model):
     primary_key_is_quite_long_zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz = models.AutoField(primary_key=True)