# 修复代码生成提示词（实例ID：scikit-learn__scikit-learn-12961）
## 代码仓库
scikit-learn/scikit-learn

## 原始问题描述
model_selection._search._format_results ValueError not enough values to unpack (expected 5, got 0)
I'm using `lightgbm 2.2.2` with `RandomizedSearchCV` in sklearn v 0.20.1. MacOS Mojave. 

```
raceback (most recent call last):
  File "gbm.py", line 1339, in <module>
    scoring=score_methods, refit='nll')
  File "gbm.py", line 1264, in param_search_lgb
    rs.fit(X_train, y_train)
  File "/Users/anaconda3/lib/python3.6/site-packages/sklearn/model_selection/_search.py", line 722, in fit
    self._run_search(evaluate_candidates)
  File "/Users//anaconda3/lib/python3.6/site-packages/sklearn/model_selection/_search.py", line 1515, in _run_search
    random_state=self.random_state))
  File "/Users/anaconda3/lib/python3.6/site-packages/sklearn/model_selection/_search.py", line 719, in evaluate_candidates
    all_candidate_params, scorers, n_splits, all_out)
  File "/Users/anaconda3/lib/python3.6/site-packages/sklearn/model_selection/_search.py", line 763, in _format_results
    score_time) = zip(*out)
ValueError: not enough values to unpack (expected 4, got 0)
```

The issue traces to these two lines below, with `return_train_score=True`

https://github.com/scikit-learn/scikit-learn/blob/55bf5d93e5674f13a1134d93a11fd0cd11aabcd1/sklearn/model_selection/_search.py#L760

Setting `return_train_score=False` did not work, still hitting the same issue.

https://github.com/scikit-learn/scikit-learn/blob/55bf5d93e5674f13a1134d93a11fd0cd11aabcd1/sklearn/model_selection/_search.py#L763

From the trackback, I suspect that the line below could be returning None. This doesn't always happen, but only sometimes. My param search was able to run for a few rounds, and then hit this issue. 

https://github.com/scikit-learn/scikit-learn/blob/55bf5d93e5674f13a1134d93a11fd0cd11aabcd1/sklearn/model_selection/_search.py#L704-719


The problem could be that lightgbm did not return valid results (have not verified), but either way, this error could be handled better. 

Does anyone have more insight into the potential cause? 

Thanks.



## 参考黄金补丁（正确的修复方案）
diff --git a/sklearn/model_selection/tests/test_search.py b/sklearn/model_selection/tests/test_search.py
--- a/sklearn/model_selection/tests/test_search.py
+++ b/sklearn/model_selection/tests/test_search.py
@@ -1725,3 +1725,47 @@ def test_deprecated_grid_search_iid():
     grid = GridSearchCV(SVC(gamma='scale'), param_grid={'C': [1]}, cv=KFold(2))
     # no warning because no stratification and 54 % 2 == 0
     assert_no_warnings(grid.fit, X, y)
+
+
+def test_empty_cv_iterator_error():
+    # Use global X, y
+
+    # create cv
+    cv = KFold(n_splits=3).split(X)
+
+    # pop all of it, this should cause the expected ValueError
+    [u for u in cv]
+    # cv is empty now
+
+    train_size = 100
+    ridge = RandomizedSearchCV(Ridge(), {'alpha': [1e-3, 1e-2, 1e-1]},
+                               cv=cv, n_jobs=-1)
+
+    # assert that this raises an error
+    with pytest.raises(ValueError,
+                       match='No fits were performed. '
+                             'Was the CV iterator empty\\? '
+                             'Were there no candidates\\?'):
+        ridge.fit(X[:train_size], y[:train_size])
+
+
+def test_random_search_bad_cv():
+    # Use global X, y
+
+    class BrokenKFold(KFold):
+        def get_n_splits(self, *args, **kw):
+            return 1
+
+    # create bad cv
+    cv = BrokenKFold(n_splits=3)
+
+    train_size = 100
+    ridge = RandomizedSearchCV(Ridge(), {'alpha': [1e-3, 1e-2, 1e-1]},
+                               cv=cv, n_jobs=-1)
+
+    # assert that this raises an error
+    with pytest.raises(ValueError,
+                       match='cv.split and cv.get_n_splits returned '
+                             'inconsistent results. Expected \\d+ '
+                             'splits, got \\d+'):
+        ridge.fit(X[:train_size], y[:train_size])