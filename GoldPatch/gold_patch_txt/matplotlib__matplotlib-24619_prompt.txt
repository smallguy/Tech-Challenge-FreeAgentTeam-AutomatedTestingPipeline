# 修复代码生成提示词（实例ID：matplotlib__matplotlib-24619）
## 代码仓库
matplotlib/matplotlib

## 原始问题描述
[Bug]: integer colours for pcolorfast / quadmesh
### Bug summary

I get an error 
```
ValueError: RGBA values should be within 0-1 range
```
when passing a byte/integer array to pcolorfast to code the colors as RGBA.  It also fails when data type is `uint8` 

### Code for reproduction

```python
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.cm import get_cmap
cmap = get_cmap('bwr_r'')
fig, ax = plt.subplots()
x, y = np.mgrid[0:10:100j, 0:10:100j]
v = np.abs(np.sin(x) * np.cos(y))
c = (cmap(v[:-1, :-1]) * 255).astype(np.int64)
ax.pcolorfast(x, y, c)
```


### Actual outcome

```
ValueError: RGBA values should be within 0-1 range
```

### Expected outcome

a plot in in some bluish colour

### Additional information

fixes:

1) in `colors.py`, line 321:
```
if (isinstance(c, np.ndarray) and c.dtype.kind in "if"
```
should be replaced by
```
if (isinstance(c, np.ndarray) and c.dtype.kind in "ifu"
```
to allow for unsigned int values as well

2) in line 343:
```
        if np.any((result < 0) | (result > 1)):
            raise ValueError("RGBA values should be within 0-1 range")
```
should be replaced by a test including dtype.kind - for 'i' and 'u'. 
It may be sufficient to comment it out as a quick fix as it is definitively more broken having it in.

 ```
        if c.dtype.kind in "f" and np.any((result < 0) | (result > 1)):
            raise ValueError("RGBA float values should be within 0-1 range")
        if c.dtype.kind in "ui" and np.any((result < 0) | (result > 255)):
            raise ValueError("RGBA fixed values should be within 0-255 range")
```
even with this it does not quite work

### Operating system

 5.15.13-200.fc35.x86_64

### Matplotlib Version

3.5.1

### Matplotlib Backend

gtk3

### Python version

3.10.1

### Jupyter version

8.0.0

### Installation

pip


## 参考黄金补丁（正确的修复方案）
diff --git a/lib/matplotlib/tests/test_axes.py b/lib/matplotlib/tests/test_axes.py
--- a/lib/matplotlib/tests/test_axes.py
+++ b/lib/matplotlib/tests/test_axes.py
@@ -1298,6 +1298,17 @@ def test_pcolormesh_alpha():
     ax4.pcolormesh(Qx, Qy, Z, cmap=cmap, shading='gouraud', zorder=1)
 
 
+@pytest.mark.parametrize("dims,alpha", [(3, 1), (4, 0.5)])
+@check_figures_equal(extensions=["png"])
+def test_pcolormesh_rgba(fig_test, fig_ref, dims, alpha):
+    ax = fig_test.subplots()
+    c = np.ones((5, 6, dims), dtype=float) / 2
+    ax.pcolormesh(c)
+
+    ax = fig_ref.subplots()
+    ax.pcolormesh(c[..., 0], cmap="gray", vmin=0, vmax=1, alpha=alpha)
+
+
 @image_comparison(['pcolormesh_datetime_axis.png'], style='mpl20')
 def test_pcolormesh_datetime_axis():
     # Remove this line when this test image is regenerated.
diff --git a/lib/matplotlib/tests/test_collections.py b/lib/matplotlib/tests/test_collections.py
--- a/lib/matplotlib/tests/test_collections.py
+++ b/lib/matplotlib/tests/test_collections.py
@@ -830,6 +830,24 @@ def test_quadmesh_set_array_validation():
                        r"are incompatible with X \(11\) and/or Y \(8\)"):
         coll.set_array(z.ravel())
 
+    # RGB(A) tests
+    z = np.ones((9, 6, 3))  # RGB with wrong X/Y dims
+    with pytest.raises(TypeError, match=r"Dimensions of A \(9, 6, 3\) "
+                       r"are incompatible with X \(11\) and/or Y \(8\)"):
+        coll.set_array(z)
+
+    z = np.ones((9, 6, 4))  # RGBA with wrong X/Y dims
+    with pytest.raises(TypeError, match=r"Dimensions of A \(9, 6, 4\) "
+                       r"are incompatible with X \(11\) and/or Y \(8\)"):
+        coll.set_array(z)
+
+    z = np.ones((7, 10, 2))  # Right X/Y dims, bad 3rd dim
+    with pytest.raises(ValueError, match=r"For X \(11\) and Y \(8\) with "
+                       r"flat shading, the expected shape of "
+                       r"A with RGB\(A\) colors is \(7, 10, \[3 or 4\]\), "
+                       r"not \(7, 10, 2\)"):
+        coll.set_array(z)
+
     x = np.arange(10)
     y = np.arange(7)
     z = np.random.random((7, 10))
@@ -1048,6 +1066,9 @@ def test_array_wrong_dimensions():
     pc = plt.pcolormesh(z)
     pc.set_array(z)  # 2D is OK for Quadmesh
     pc.update_scalarmappable()
+    # 3D RGB is OK as well
+    z = np.arange(36).reshape(3, 4, 3)
+    pc.set_array(z)
 
 
 def test_get_segments():