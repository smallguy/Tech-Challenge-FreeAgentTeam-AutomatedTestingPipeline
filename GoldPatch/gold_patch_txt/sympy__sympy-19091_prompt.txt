# 修复代码生成提示词（实例ID：sympy__sympy-19091）
## 代码仓库
sympy/sympy

## 原始问题描述
Tensor contractions are wrong
This is essentially a generalization of #17328.

The problem in the current implementation is that contractions are handled before applications of the metric, which leads to incorrect results such as in #17328.

In `tensor/tensor.py`:
```python
class Tensor(TensExpr):
# ...
    def _extract_data(self, replacement_dict):
    # ...
        if len(dum1) > 0:
            indices2 = other.get_indices()
            repl = {}
            for p1, p2 in dum1:
                repl[indices2[p2]] = -indices2[p1]
            other = other.xreplace(repl).doit()
            array = _TensorDataLazyEvaluator.data_contract_dum([array], dum1, len(indices2))

        free_ind1 = self.get_free_indices()
        free_ind2 = other.get_free_indices()

        return self._match_indices_with_other_tensor(array, free_ind1, free_ind2, replacement_dict)
```
And thus, the issue is that `_TensorDataLazyEvaluator.data_contract_dum` is being called prior to `self._match_indices_with_other_tensor` (where the metric is applied).

The reason that this ordering matters is because tensor contraction is itself the abstraction of applying the metric to the tensors that represent psuedo-riemannian manifolds. In essence, it means that we must have it that ![equation](https://latex.codecogs.com/svg.latex?T^\mu_\mu=g_{\mu\nu}T^{\mu\nu}); however, this isn't the case here.

I've tried tampering with the code above, but by the way tensors have been designed, this bug is essentially unavoidable. As a consequence, the tensor module needs to be refactored in order to get accurate results. (Also, I couldn't help but notice that the last argument to `_TensorDataLazyEvaluator.data_contract_dum` isn't used).

@drybalka had mentioned that he had this sort of refactoring in the works, but based on his fork, progress seems to be slow. I think discussions should be in order for reorganizing how tensors actually represent their components in this module.


## 参考黄金补丁（正确的修复方案）
diff --git a/sympy/tensor/tests/test_tensor.py b/sympy/tensor/tests/test_tensor.py
--- a/sympy/tensor/tests/test_tensor.py
+++ b/sympy/tensor/tests/test_tensor.py
@@ -1910,6 +1910,13 @@ def test_tensor_replacement():
     repl = {H(i, -i): 42}
     assert expr._extract_data(repl) == ([], 42)
 
+    expr = H(i, -i)
+    repl = {
+        H(-i, -j): Array([[1, 0, 0, 0], [0, -1, 0, 0], [0, 0, -1, 0], [0, 0, 0, -1]]),
+        L: Array([[1, 0, 0, 0], [0, -1, 0, 0], [0, 0, -1, 0], [0, 0, 0, -1]]),
+    }
+    assert expr._extract_data(repl) == ([], 4)
+
     # Replace with array, raise exception if indices are not compatible:
     expr = A(i)*A(j)
     repl = {A(i): [1, 2]}