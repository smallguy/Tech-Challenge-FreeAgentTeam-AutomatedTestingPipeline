# 修复代码生成提示词（实例ID：sphinx-doc__sphinx-11544）
## 代码仓库
sphinx-doc/sphinx

## 原始问题描述
linkcheck failing after Sphinx 7.1.0 release
### Describe the bug

Starting with `Sphinx 7.1.0`, my package(s) started reporting `linkcheck` failures due to "Anchor not found", e.g., https://github.com/astropy/photutils/actions/runs/5688763395/job/15419142358.

Reverting to Sphinx 7.0.1 fixes the issue.

`git bisect` reveals the issue started with e45fb5e61b6ea3ee707a9e4ee8792f45c9246fae, this PR: https://github.com/sphinx-doc/sphinx/pull/11432

### How to Reproduce

$ git clone git@github.com:astropy/photutils.git
$ cd photutils
$ tox -e linkcheck


### Environment Information

```text
Platform:              darwin; (macOS-13.5-x86_64-i386-64bit)
Python version:        3.11.3 (main, May 26 2023, 21:36:22) [Clang 14.0.3 (clang-1403.0.22.14.1)])
Python implementation: CPython
Sphinx version:        7.1.1
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

_No response_

### Additional context

_No response_


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/test_build_linkcheck.py b/tests/test_build_linkcheck.py
--- a/tests/test_build_linkcheck.py
+++ b/tests/test_build_linkcheck.py
@@ -152,6 +152,7 @@ def test_defaults(app):
     }
     # looking for '#top' and '#does-not-exist' not found should fail
     assert rowsby["http://localhost:7777/#top"]["info"] == "Anchor 'top' not found"
+    assert rowsby["http://localhost:7777/#top"]["status"] == "broken"
     assert rowsby["http://localhost:7777#does-not-exist"]["info"] == "Anchor 'does-not-exist' not found"
     # images should fail
     assert "Not Found for url: http://localhost:7777/image.png" in rowsby["http://localhost:7777/image.png"]["info"]
@@ -166,6 +167,22 @@ def test_defaults(app):
     }
 
 
+@pytest.mark.sphinx(
+    'linkcheck', testroot='linkcheck', freshenv=True,
+    confoverrides={'linkcheck_anchors': False})
+def test_check_link_response_only(app):
+    with http_server(DefaultsHandler):
+        app.build()
+
+    # JSON output
+    assert (app.outdir / 'output.json').exists()
+    content = (app.outdir / 'output.json').read_text(encoding='utf8')
+
+    rows = [json.loads(x) for x in content.splitlines()]
+    rowsby = {row["uri"]: row for row in rows}
+    assert rowsby["http://localhost:7777/#top"]["status"] == "working"
+
+
 @pytest.mark.sphinx('linkcheck', testroot='linkcheck-too-many-retries', freshenv=True)
 def test_too_many_retries(app):
     with http_server(DefaultsHandler):