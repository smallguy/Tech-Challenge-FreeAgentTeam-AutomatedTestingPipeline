# 修复代码生成提示词（实例ID：sphinx-doc__sphinx-11550）
## 代码仓库
sphinx-doc/sphinx

## 原始问题描述
autodoc preserve defaults leads to exception on multiline lambda
### Describe the bug

In [cssutils](/jaraco/cssutils), I've stumbled into an issue where the docs builds are failing (https://github.com/jaraco/cssutils/issues/36).

After some [investigation](https://stackoverflow.com/questions/76443979/exception-invalid-syntax-while-formatting-arguments-for-property), I learned that the issue seems to be related to the use of `autodoc` with `autodoc_preserve_defaults = True` and the use of `property(lambda)` where the lambda is on a different line from the `property`.

### How to Reproduce

```
 draft $ cat mod.py
class X:
  foo = property(
    lambda self: None, doc="Foo.")
 draft $ cat conf.py
extensions = [
    'sphinx.ext.autodoc',
]

master_doc = "index"

# Preserve authored syntax for defaults
autodoc_preserve_defaults = True
 draft $ cat index.rst
.. automodule:: mod
    :members:
    :undoc-members:
 draft $ pip-run sphinx -- -m sphinx . build
Running Sphinx v7.0.1
making output directory... done
building [mo]: targets for 0 po files that are out of date
writing output... 
building [html]: targets for 1 source files that are out of date
updating environment: [new config] 1 added, 0 changed, 0 removed
reading sources... [100%] index                                                                                                                
WARNING: error while formatting arguments for mod.X.foo: Handler <function update_defvalue at 0x102c2b100> for event 'autodoc-before-process-signature' threw an exception (exception: unmatched ')' (<unknown>, line 2))
looking for now-outdated files... none found
pickling environment... done
checking consistency... done
preparing documents... done
writing output... [100%] index                                                                                                                 
generating indices... genindex py-modindex done
writing additional pages... search done
copying static files... done
copying extra files... done
dumping search index in English (code: en)... done
dumping object inventory... done
build succeeded, 1 warning.

The HTML pages are in build.
```

### Environment Information

```text
draft $ pip-run sphinx -- -m sphinx --bug-report
Please paste all output below into the bug report template



Platform:              darwin; (macOS-13.4-arm64-arm-64bit)
Python version:        3.11.3 (main, Apr  7 2023, 20:13:31) [Clang 14.0.0 (clang-1400.0.29.202)])
Python implementation: CPython
Sphinx version:        7.0.1
Docutils version:      0.20.1
Jinja2 version:        3.1.2
Pygments version:      2.15.1
```


### Sphinx extensions

```python
sphinx.ext.autodoc
```


### Additional context

Weirdly, removing the carriage return after `property(` suppresses the error. Also, converting to a traditional `@property` decorator or replacing the lambda with a simple function also suppresses the error:

```
class X:
  def _f(self):
    return
  foo = property(
    _f, doc="Foo.")
```


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/roots/test-ext-autodoc/target/preserve_defaults.py b/tests/roots/test-ext-autodoc/target/preserve_defaults.py
--- a/tests/roots/test-ext-autodoc/target/preserve_defaults.py
+++ b/tests/roots/test-ext-autodoc/target/preserve_defaults.py
@@ -30,3 +30,31 @@ def clsmeth(cls, name: str = CONSTANT, sentinel: Any = SENTINEL,
                 now: datetime = datetime.now(), color: int = 0xFFFFFF,
                 *, kwarg1, kwarg2 = 0xFFFFFF) -> None:
         """docstring"""
+
+
+get_sentinel = lambda custom=SENTINEL: custom
+"""docstring"""
+
+
+class MultiLine:
+    """docstring"""
+
+    # The properties will raise a silent SyntaxError because "lambda self: 1"
+    # will be detected as a function to update the default values of. However,
+    # only prop3 will not fail because it's on a single line whereas the others
+    # will fail to parse.
+
+    prop1 = property(
+      lambda self: 1, doc="docstring")
+
+    prop2 = property(
+      lambda self: 2, doc="docstring"
+    )
+
+    prop3 = property(lambda self: 3, doc="docstring")
+
+    prop4 = (property
+    (lambda self: 4, doc="docstring"))
+
+    prop5 = property\
+    (lambda self: 5, doc="docstring")
diff --git a/tests/roots/test-ext-autodoc/target/preserve_defaults_special_constructs.py b/tests/roots/test-ext-autodoc/target/preserve_defaults_special_constructs.py
new file mode 100644
--- /dev/null
+++ b/tests/roots/test-ext-autodoc/target/preserve_defaults_special_constructs.py
@@ -0,0 +1,50 @@
+from __future__ import annotations
+
+from collections import namedtuple
+from dataclasses import dataclass, field
+from typing import NamedTuple, TypedDict
+
+#: docstring
+SENTINEL = object()
+
+
+#: docstring
+ze_lambda = lambda z=SENTINEL: None
+
+
+def foo(x, y, z=SENTINEL):
+    """docstring"""
+
+
+@dataclass
+class DataClass:
+    """docstring"""
+    a: int
+    b: object = SENTINEL
+    c: list[int] = field(default_factory=lambda: [1, 2, 3])
+
+
+@dataclass(init=False)
+class DataClassNoInit:
+    """docstring"""
+    a: int
+    b: object = SENTINEL
+    c: list[int] = field(default_factory=lambda: [1, 2, 3])
+
+
+class MyTypedDict(TypedDict):
+    """docstring"""
+    a: int
+    b: object
+    c: list[int]
+
+
+class MyNamedTuple1(NamedTuple):
+    """docstring"""
+    a: int
+    b: object = object()
+    c: list[int] = [1, 2, 3]
+
+
+class MyNamedTuple2(namedtuple('Base', ('a', 'b'), defaults=(0, SENTINEL))):
+    """docstring"""
diff --git a/tests/test_ext_autodoc_preserve_defaults.py b/tests/test_ext_autodoc_preserve_defaults.py
--- a/tests/test_ext_autodoc_preserve_defaults.py
+++ b/tests/test_ext_autodoc_preserve_defaults.py
@@ -40,6 +40,42 @@ def test_preserve_defaults(app):
         '      docstring',
         '',
         '',
+        '.. py:class:: MultiLine()',
+        '   :module: target.preserve_defaults',
+        '',
+        '   docstring',
+        '',
+        '',
+        '   .. py:property:: MultiLine.prop1',
+        '      :module: target.preserve_defaults',
+        '',
+        '      docstring',
+        '',
+        '',
+        '   .. py:property:: MultiLine.prop2',
+        '      :module: target.preserve_defaults',
+        '',
+        '      docstring',
+        '',
+        '',
+        '   .. py:property:: MultiLine.prop3',
+        '      :module: target.preserve_defaults',
+        '',
+        '      docstring',
+        '',
+        '',
+        '   .. py:property:: MultiLine.prop4',
+        '      :module: target.preserve_defaults',
+        '',
+        '      docstring',
+        '',
+        '',
+        '   .. py:property:: MultiLine.prop5',
+        '      :module: target.preserve_defaults',
+        '',
+        '      docstring',
+        '',
+        '',
         '.. py:function:: foo(name: str = CONSTANT, sentinel: ~typing.Any = SENTINEL, '
         'now: ~datetime.datetime = datetime.now(), color: int = %s, *, kwarg1, '
         'kwarg2=%s) -> None' % (color, color),
@@ -47,4 +83,110 @@ def test_preserve_defaults(app):
         '',
         '   docstring',
         '',
+        '',
+        '.. py:function:: get_sentinel(custom=SENTINEL)',
+        '   :module: target.preserve_defaults',
+        '',
+        '   docstring',
+        '',
+    ]
+
+
+@pytest.mark.sphinx('html', testroot='ext-autodoc',
+                    confoverrides={'autodoc_preserve_defaults': True})
+def test_preserve_defaults_special_constructs(app):
+    options = {"members": None}
+    actual = do_autodoc(app, 'module', 'target.preserve_defaults_special_constructs', options)
+
+    # * dataclasses.dataclass:
+    #   - __init__ source code is not available
+    #   - default values specified at class level are not discovered
+    #   - values wrapped in a field(...) expression cannot be analyzed
+    #     easily even if annotations were to be parsed
+    # * typing.NamedTuple:
+    #   - __init__ source code is not available
+    #   - default values specified at class level are not discovered
+    # * collections.namedtuple:
+    #   - default values are specified as "default=(d1, d2, ...)"
+    #
+    # In the future, it might be possible to find some additional default
+    # values by parsing the source code of the annotations but the task is
+    # rather complex.
+
+    assert list(actual) == [
+        '',
+        '.. py:module:: target.preserve_defaults_special_constructs',
+        '',
+        '',
+        '.. py:class:: DataClass('
+        'a: int, b: object = <object object>, c: list[int] = <factory>)',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:class:: DataClassNoInit()',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:class:: MyNamedTuple1('
+        'a: int, b: object = <object object>, c: list[int] = [1, 2, 3])',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '   .. py:attribute:: MyNamedTuple1.a',
+        '      :module: target.preserve_defaults_special_constructs',
+        '      :type: int',
+        '',
+        '      Alias for field number 0',
+        '',
+        '',
+        '   .. py:attribute:: MyNamedTuple1.b',
+        '      :module: target.preserve_defaults_special_constructs',
+        '      :type: object',
+        '',
+        '      Alias for field number 1',
+        '',
+        '',
+        '   .. py:attribute:: MyNamedTuple1.c',
+        '      :module: target.preserve_defaults_special_constructs',
+        '      :type: list[int]',
+        '',
+        '      Alias for field number 2',
+        '',
+        '',
+        '.. py:class:: MyNamedTuple2(a=0, b=<object object>)',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:class:: MyTypedDict',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:data:: SENTINEL',
+        '   :module: target.preserve_defaults_special_constructs',
+        '   :value: <object object>',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:function:: foo(x, y, z=SENTINEL)',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
+        '',
+        '.. py:function:: ze_lambda(z=SENTINEL)',
+        '   :module: target.preserve_defaults_special_constructs',
+        '',
+        '   docstring',
+        '',
     ]