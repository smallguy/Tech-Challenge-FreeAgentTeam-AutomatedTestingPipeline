# 修复代码生成提示词（实例ID：django__django-12430）
## 代码仓库
django/django

## 原始问题描述
Possible data loss when using caching from async code.
Description
	
CacheHandler use threading.local instead of asgiref.local.Local, hence it's a chance of data corruption if someone tries to use caching from async code. There is a potential race condition if two coroutines touch the same cache object at exactly the same time.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/async/tests.py b/tests/async/tests.py
--- a/tests/async/tests.py
+++ b/tests/async/tests.py
@@ -4,6 +4,7 @@
 
 from asgiref.sync import async_to_sync
 
+from django.core.cache import DEFAULT_CACHE_ALIAS, caches
 from django.core.exceptions import SynchronousOnlyOperation
 from django.test import SimpleTestCase
 from django.utils.asyncio import async_unsafe
@@ -11,6 +12,18 @@
 from .models import SimpleModel
 
 
+@skipIf(sys.platform == 'win32' and (3, 8, 0) < sys.version_info < (3, 8, 1), 'https://bugs.python.org/issue38563')
+class CacheTest(SimpleTestCase):
+    def test_caches_local(self):
+        @async_to_sync
+        async def async_cache():
+            return caches[DEFAULT_CACHE_ALIAS]
+
+        cache_1 = async_cache()
+        cache_2 = async_cache()
+        self.assertIs(cache_1, cache_2)
+
+
 @skipIf(sys.platform == 'win32' and (3, 8, 0) < sys.version_info < (3, 8, 1), 'https://bugs.python.org/issue38563')
 class DatabaseConnectionTest(SimpleTestCase):
     """A database connection cannot be used in an async context."""