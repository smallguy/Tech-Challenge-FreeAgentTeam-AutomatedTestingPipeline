# 修复代码生成提示词（实例ID：django__django-14802）
## 代码仓库
django/django

## 原始问题描述
Add a helper function to make and validate cache keys.
Description
	
Following from ​this thread the following pattern is repeated a lot in the cache backends:
		key = self.make_key(key, version=version)
		self.validate_key(key)
We can define a helper function on the base cache backend that can be used to avoid repetitiveness and help ensure that we consistently call .validate_key() after .make_key():
	def make_and_validate_key(self, key, version=None):
		key = self.make_key(key, version=version)
		self.validate_key(key)
		return key
An alternative proposal is to have .make_key() learn a validate flag, but we'd probably need to have it as False by default for backward compatibility and we'd may still have issues if users have overridden .make_key(). So it would require documentation changes, release notes, and a deprecation period.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/cache/tests.py b/tests/cache/tests.py
--- a/tests/cache/tests.py
+++ b/tests/cache/tests.py
@@ -675,7 +675,7 @@ def test_cull_delete_when_store_empty(self):
         finally:
             cull_cache._max_entries = old_max_entries
 
-    def _perform_invalid_key_test(self, key, expected_warning):
+    def _perform_invalid_key_test(self, key, expected_warning, key_func=None):
         """
         All the builtin backends should warn (except memcached that should
         error) on keys that would be refused by memcached. This encourages
@@ -688,7 +688,7 @@ def func(key, *args):
             return key
 
         old_func = cache.key_func
-        cache.key_func = func
+        cache.key_func = key_func or func
 
         tests = [
             ('add', [key, 1]),
@@ -725,6 +725,19 @@ def test_invalid_key_length(self):
         )
         self._perform_invalid_key_test(key, expected_warning)
 
+    def test_invalid_with_version_key_length(self):
+        # Custom make_key() that adds a version to the key and exceeds the
+        # limit.
+        def key_func(key, *args):
+            return key + ':1'
+
+        key = 'a' * 249
+        expected_warning = (
+            'Cache key will cause errors if used with memcached: '
+            '%r (longer than %s)' % (key_func(key), 250)
+        )
+        self._perform_invalid_key_test(key, expected_warning, key_func=key_func)
+
     def test_cache_versioning_get_set(self):
         # set, using default version = 1
         cache.set('answer1', 42)
@@ -1417,6 +1430,15 @@ def _perform_invalid_key_test(self, key, expected_warning):
                     getattr(cache, operation)(*args)
                 self.assertEqual(str(cm.exception), msg)
 
+    def test_invalid_with_version_key_length(self):
+        # make_key() adds a version to the key and exceeds the limit.
+        key = 'a' * 248
+        expected_warning = (
+            'Cache key will cause errors if used with memcached: '
+            '%r (longer than %s)' % (key, 250)
+        )
+        self._perform_invalid_key_test(key, expected_warning)
+
     def test_default_never_expiring_timeout(self):
         # Regression test for #22845
         with self.settings(CACHES=caches_setting_for_tests(