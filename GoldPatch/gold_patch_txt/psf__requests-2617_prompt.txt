# 修复代码生成提示词（实例ID：psf__requests-2617）
## 代码仓库
psf/requests

## 原始问题描述
Prepared requests containing binary files will not send when unicode_literals is imported
``` python
#!/usr/bin/env python                                                                                                                                                              
from __future__ import unicode_literals
import requests
import sys


def main():
    request = requests.Request(method='PUT', url='https://httpbin.org/put')
    with open(sys.argv[1], 'rb') as fp:
        request.files = {'hello': fp}
        prepared = request.prepare()
        requests.Session().send(prepared)

if __name__ == '__main__':
    sys.exit(main())
```

The above program works perfectly in python3, and in python2 when `unicode_literals` is not imported. If the request isn't prepared it works without a problem unfortunately, I require both prepared requests and `unicode_literals` in my project.

The exception raised is:

``````
Traceback (most recent call last):
  File "./test.py", line 15, in <module>
    sys.exit(main())
  File "./test.py", line 12, in main
    requests.Session().send(prepared)
  File "/Users/bboe/.venv/p27/lib/python2.7/site-packages/requests-2.7.0-py2.7.egg/requests/sessions.py", line 573, in send
    r = adapter.send(request, **kwargs)
  File "/Users/bboe/.venv/p27/lib/python2.7/site-packages/requests-2.7.0-py2.7.egg/requests/adapters.py", line 370, in send
    timeout=timeout
  File "/Users/bboe/.venv/p27/lib/python2.7/site-packages/requests-2.7.0-py2.7.egg/requests/packages/urllib3/connectionpool.py", line 544, in urlopen
    body=body, headers=headers)
  File "/Users/bboe/.venv/p27/lib/python2.7/site-packages/requests-2.7.0-py2.7.egg/requests/packages/urllib3/connectionpool.py", line 349, in _make_request
    conn.request(method, url, **httplib_request_kw)
  File "/usr/local/Cellar/python/2.7.9/Frameworks/Python.framework/Versions/2.7/lib/python2.7/httplib.py", line 1001, in request
    self._send_request(method, url, body, headers)
  File "/usr/local/Cellar/python/2.7.9/Frameworks/Python.framework/Versions/2.7/lib/python2.7/httplib.py", line 1035, in _send_request
    self.endheaders(body)
  File "/usr/local/Cellar/python/2.7.9/Frameworks/Python.framework/Versions/2.7/lib/python2.7/httplib.py", line 997, in endheaders
    self._send_output(message_body)
  File "/usr/local/Cellar/python/2.7.9/Frameworks/Python.framework/Versions/2.7/lib/python2.7/httplib.py", line 848, in _send_output
    msg += message_body
UnicodeDecodeError: 'ascii' codec can't decode byte 0xff in position 109: ordinal not in range(128)```
``````



## 参考黄金补丁（正确的修复方案）
diff --git a/test_requests.py b/test_requests.py
--- a/test_requests.py
+++ b/test_requests.py
@@ -89,7 +89,7 @@ def test_invalid_url(self):
             requests.get('http://')
 
     def test_basic_building(self):
-        req = requests.Request()
+        req = requests.Request(method='GET')
         req.url = 'http://kennethreitz.org/'
         req.data = {'life': '42'}
 
@@ -813,7 +813,7 @@ def test_get_auth_from_url_encoded_hashes(self):
         assert ('user', 'pass#pass') == requests.utils.get_auth_from_url(url)
 
     def test_cannot_send_unprepared_requests(self):
-        r = requests.Request(url=HTTPBIN)
+        r = requests.Request(method='GET', url=HTTPBIN)
         with pytest.raises(ValueError):
             requests.Session().send(r)
 
@@ -1617,6 +1617,16 @@ def test_prepare_unicode_url():
     assert_copy(p, p.copy())
 
 
+def test_prepare_requires_a_request_method():
+    req = requests.Request()
+    with pytest.raises(ValueError):
+        req.prepare()
+
+    prepped = PreparedRequest()
+    with pytest.raises(ValueError):
+        prepped.prepare()
+
+
 def test_urllib3_retries():
     from requests.packages.urllib3.util import Retry
     s = requests.Session()