# 修复代码生成提示词（实例ID：django__django-14861）
## 代码仓库
django/django

## 原始问题描述
Conditionally changing ModelAdmin inlines based on object's field breaks when changing object and new inlines should appear.
Description
	
Minimal example:
# models.py
class Parent(models.Model):
	show_inlines = models.BooleanField(default=False)
class Child(models.Model):
	parent = models.ForeignKey(Parent, on_delete=models.CASCADE)
# admin.py
class ChildInline(admin.StackedInline):
	model = Child
@admin.register(Parent)
class ParentAdmin(admin.ModelAdmin):
	def get_inlines(self, request, obj):
		if obj is not None and obj.show_inlines:
			return [ChildInline]
		return []
Create Parent objects in either initial state and it works as you'd expect, where ChildInline is rendered when show_inlines is True.
When show_inlines is True, you can also set it to False from the admin site, and the ChildInline disappears as expected.
But when show_inlines is False, you cannot re-enable it. Saving the object fails due to a validation error in the new ChildInline that didn't exist before saving:
(Hidden field TOTAL_FORMS) This field is required.
(Hidden field INITIAL_FORMS) This field is required.
ManagementForm data is missing or has been tampered with. Missing fields: child_set-TOTAL_FORMS, child_set-INITIAL_FORMS. You may need to file a bug report if the issue persists.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/admin_inlines/admin.py b/tests/admin_inlines/admin.py
--- a/tests/admin_inlines/admin.py
+++ b/tests/admin_inlines/admin.py
@@ -11,8 +11,9 @@
     Inner4Tabular, Inner5Stacked, Inner5Tabular, NonAutoPKBook,
     NonAutoPKBookChild, Novel, NovelReadonlyChapter, OutfitItem,
     ParentModelWithCustomPk, Person, Poll, Profile, ProfileCollection,
-    Question, ReadOnlyInline, ShoppingWeakness, Sighting, SomeChildModel,
-    SomeParentModel, SottoCapo, Teacher, Title, TitleCollection,
+    Question, ReadOnlyInline, ShoppingWeakness, ShowInlineChild,
+    ShowInlineParent, Sighting, SomeChildModel, SomeParentModel, SottoCapo,
+    Teacher, Title, TitleCollection,
 )
 
 site = admin.AdminSite(name="admin")
@@ -371,6 +372,17 @@ class ChildHiddenFieldOnSingleLineStackedInline(admin.StackedInline):
     fields = ('name', 'position')
 
 
+class ShowInlineChildInline(admin.StackedInline):
+    model = ShowInlineChild
+
+
+class ShowInlineParentAdmin(admin.ModelAdmin):
+    def get_inlines(self, request, obj):
+        if obj is not None and obj.show_inlines:
+            return [ShowInlineChildInline]
+        return []
+
+
 site.register(TitleCollection, inlines=[TitleInline])
 # Test bug #12561 and #12778
 # only ModelAdmin media
@@ -402,6 +414,7 @@ class ChildHiddenFieldOnSingleLineStackedInline(admin.StackedInline):
 site.register(CourseProxy, ClassAdminStackedVertical)
 site.register(CourseProxy1, ClassAdminTabularVertical)
 site.register(CourseProxy2, ClassAdminTabularHorizontal)
+site.register(ShowInlineParent, ShowInlineParentAdmin)
 # Used to test hidden fields in tabular and stacked inlines.
 site2 = admin.AdminSite(name='tabular_inline_hidden_field_admin')
 site2.register(SomeParentModel, inlines=[ChildHiddenFieldTabularInline])
diff --git a/tests/admin_inlines/models.py b/tests/admin_inlines/models.py
--- a/tests/admin_inlines/models.py
+++ b/tests/admin_inlines/models.py
@@ -327,6 +327,12 @@ class Meta:
 
 
 # Other models
+class ShowInlineParent(models.Model):
+    show_inlines = models.BooleanField(default=False)
+
+
+class ShowInlineChild(models.Model):
+    parent = models.ForeignKey(ShowInlineParent, on_delete=models.CASCADE)
 
 
 class ProfileCollection(models.Model):
diff --git a/tests/admin_inlines/tests.py b/tests/admin_inlines/tests.py
--- a/tests/admin_inlines/tests.py
+++ b/tests/admin_inlines/tests.py
@@ -12,8 +12,8 @@
     ChildModel1, ChildModel2, Fashionista, FootNote, Holder, Holder2, Holder3,
     Holder4, Inner, Inner2, Inner3, Inner4Stacked, Inner4Tabular, Novel,
     OutfitItem, Parent, ParentModelWithCustomPk, Person, Poll, Profile,
-    ProfileCollection, Question, Sighting, SomeChildModel, SomeParentModel,
-    Teacher, VerboseNamePluralProfile, VerboseNameProfile,
+    ProfileCollection, Question, ShowInlineParent, Sighting, SomeChildModel,
+    SomeParentModel, Teacher, VerboseNamePluralProfile, VerboseNameProfile,
 )
 
 INLINE_CHANGELINK_HTML = 'class="inlinechangelink">Change</a>'
@@ -618,6 +618,21 @@ def test_inlines_singular_heading_one_to_one(self):
         self.assertContains(response, '<h2>Author</h2>', html=True)  # Tabular.
         self.assertContains(response, '<h2>Fashionista</h2>', html=True)  # Stacked.
 
+    def test_inlines_based_on_model_state(self):
+        parent = ShowInlineParent.objects.create(show_inlines=False)
+        data = {
+            'show_inlines': 'on',
+            '_save': 'Save',
+        }
+        change_url = reverse(
+            'admin:admin_inlines_showinlineparent_change',
+            args=(parent.id,),
+        )
+        response = self.client.post(change_url, data)
+        self.assertEqual(response.status_code, 302)
+        parent.refresh_from_db()
+        self.assertIs(parent.show_inlines, True)
+
 
 @override_settings(ROOT_URLCONF='admin_inlines.urls')
 class TestInlineMedia(TestDataMixin, TestCase):