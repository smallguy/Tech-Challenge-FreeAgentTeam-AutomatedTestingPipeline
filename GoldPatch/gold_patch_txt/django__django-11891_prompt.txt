# 修复代码生成提示词（实例ID：django__django-11891）
## 代码仓库
django/django

## 原始问题描述
ConditionalGetMiddleware returns 304 if ETag is the same but Last-Modified has changed.
Description
	 
		(last modified by Mariusz Felisiak)
	 
ConditionalGetMiddleware in combination with apache x-sendfile (django-sendfile) doesn't work properly.
Each response gets a ETag generated based on response.content which is an empty string in the case of a x-sendfile response, so each time the file is accessed, the ETag generated by ConditionalGetMiddleware is the same. Regardless of the changed file/changed mtime. In get_conditional_response() the ETag (which is always the same hash of empty string) is checked first and returns a 304 because it ignores Last-Modified time. Django shouldn't return 304 if ETag is the same but Last-Modified has changed.
Related with #29241.


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/middleware/tests.py b/tests/middleware/tests.py
--- a/tests/middleware/tests.py
+++ b/tests/middleware/tests.py
@@ -452,6 +452,12 @@ def test_no_etag_streaming_response(self):
         res = StreamingHttpResponse(['content'])
         self.assertFalse(ConditionalGetMiddleware().process_response(self.req, res).has_header('ETag'))
 
+    def test_no_etag_response_empty_content(self):
+        res = HttpResponse()
+        self.assertFalse(
+            ConditionalGetMiddleware().process_response(self.req, res).has_header('ETag')
+        )
+
     def test_no_etag_no_store_cache(self):
         self.resp['Cache-Control'] = 'No-Cache, No-Store, Max-age=0'
         self.assertFalse(ConditionalGetMiddleware().process_response(self.req, self.resp).has_header('ETag'))