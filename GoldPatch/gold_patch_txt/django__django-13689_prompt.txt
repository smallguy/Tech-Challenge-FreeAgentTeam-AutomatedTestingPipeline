# 修复代码生成提示词（实例ID：django__django-13689）
## 代码仓库
django/django

## 原始问题描述
Aggregating when grouping on an ExpressionWrapper omits the expression from the group by
Description
	
I ran into this with Postgres on Django 3.1.3, I'm not sure what other versions it exists on.
print(
	Fred.objects.annotate(
		bob_id__is_null=ExpressionWrapper(
			Q(bob_id=None), 
			output_field=BooleanField()
		)
	).values(
		"bob_id__is_null"
	).annotate(
		id__count=Count("id", distinct=True)
	).values(
		"bob_id__is_null", 
		"id__count"
	).query
)
SELECT 
	"main_fred"."bob_id" IS NULL AS "bob_id__is_null", 
	COUNT(DISTINCT "main_fred"."id") AS "id__count" 
FROM "main_fred"
GROUP BY "main_fred"."bob_id"
On the last line there the group by has dropped the "IS NULL"


## 参考黄金补丁（正确的修复方案）
diff --git a/tests/annotations/tests.py b/tests/annotations/tests.py
--- a/tests/annotations/tests.py
+++ b/tests/annotations/tests.py
@@ -195,6 +195,18 @@ def test_q_expression_annotation_with_aggregation(self):
         self.assertEqual(book.isnull_pubdate, False)
         self.assertEqual(book.rating_count, 1)
 
+    @skipUnlessDBFeature('supports_boolean_expr_in_select_clause')
+    def test_grouping_by_q_expression_annotation(self):
+        authors = Author.objects.annotate(
+            under_40=ExpressionWrapper(Q(age__lt=40), output_field=BooleanField()),
+        ).values('under_40').annotate(
+            count_id=Count('id'),
+        ).values('under_40', 'count_id')
+        self.assertCountEqual(authors, [
+            {'under_40': False, 'count_id': 3},
+            {'under_40': True, 'count_id': 6},
+        ])
+
     def test_aggregate_over_annotation(self):
         agg = Author.objects.annotate(other_age=F('age')).aggregate(otherage_sum=Sum('other_age'))
         other_agg = Author.objects.aggregate(age_sum=Sum('age'))