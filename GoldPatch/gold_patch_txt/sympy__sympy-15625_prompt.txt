# 修复代码生成提示词（实例ID：sympy__sympy-15625）
## 代码仓库
sympy/sympy

## 原始问题描述
Jupyter notebook LaTeX output breaks when processed in LaTeX, ironically
Steps to reproduce:

* Create a Jupyter notebook (named, say, `mynotebook.ipynb`) with this content:

  ```python
  import sympy as sp
  sp.init_printing()
  1
  ```

* Convert it to LaTeX (you can remove the `--execute` flag if you saved the result in the notebook):

      python3 -m nbconvert mynotebook.ipynb --execute --to pdf

This creates the error (originating from LaTeX):

```
...
! LaTeX Error: Bad math environment delimiter.

See the LaTeX manual or LaTeX Companion for explanation.
Type  H <return>  for immediate help.
 ...                                              
                                                  
l.300     $$\begin{equation*}
                             1\end{equation*}$$
? 
! Emergency stop.
 ...                                              
                                                  
l.300     $$\begin{equation*}
                             1\end{equation*}$$
...
```

If you only convert `--to latex`, you'll see that this LaTeX code is generated:

```latex
...
\texttt{\color{outcolor}Out[{\color{outcolor}1}]:}
    
    $$\begin{equation*}1\end{equation*}$$
...
```

The reason for this error message is that the `equation*` environment is meant to be used in text mode, but sandwiching the whole thing between `$$` switches to math mode.

In this case the `$$` should simply be removed, but a general solution to this problem might be more involved.
LaTeX printing: $$...$$ -> $\displaystyle ...$
#### References to other Issues or PRs

Same thing for IPython: https://github.com/ipython/ipython/pull/11357

Somewhat related: https://github.com/jupyter/nbconvert/pull/892

#### Brief description of what is fixed or changed

Change the LaTeX wrapping from `$$`...`$$` to `$\displaystyle `...`$`

#### Other comments

This left-aligns expressions when exporting to LaTeX.

Before:

![grafik](https://user-images.githubusercontent.com/705404/46369833-5642c800-c684-11e8-9d11-600ab87c3dc2.png)

After:

![grafik](https://user-images.githubusercontent.com/705404/46369898-7bcfd180-c684-11e8-8e71-275a7ba45bca.png)

#### Release Notes

<!-- BEGIN RELEASE NOTES -->
* printing
  * change from `$$`...`$$` to `$\displaystyle `...`$` to allow left-aligning in LaTeX documents
<!-- END RELEASE NOTES -->



## 参考黄金补丁（正确的修复方案）
diff --git a/sympy/interactive/tests/test_ipythonprinting.py b/sympy/interactive/tests/test_ipythonprinting.py
--- a/sympy/interactive/tests/test_ipythonprinting.py
+++ b/sympy/interactive/tests/test_ipythonprinting.py
@@ -88,7 +88,7 @@ def test_print_builtin_option():
                     u'{n\N{LATIN SUBSCRIPT SMALL LETTER I}: 3, \N{GREEK SMALL LETTER PI}: 3.14}',
                     "{n_i: 3, pi: 3.14}",
                     u'{\N{GREEK SMALL LETTER PI}: 3.14, n\N{LATIN SUBSCRIPT SMALL LETTER I}: 3}')
-    assert latex == r'$$\begin{equation*}\left \{ n_{i} : 3, \quad \pi : 3.14\right \}\end{equation*}$$'
+    assert latex == r'$\displaystyle \left \{ n_{i} : 3, \quad \pi : 3.14\right \}$'
 
     app.run_cell("inst.display_formatter.formatters['text/latex'].enabled = True")
     app.run_cell("init_printing(use_latex=True, print_builtin=False)")
@@ -135,7 +135,7 @@ def test_builtin_containers():
 ([ ],)
  [2]  \
 """
-        assert app.user_ns['c']['text/latex'] == '$$\\begin{equation*}\\left ( \\left[\\begin{matrix}1\\\\2\\end{matrix}\\right]\\right )\\end{equation*}$$'
+        assert app.user_ns['c']['text/latex'] == '$\\displaystyle \\left ( \\left[\\begin{matrix}1\\\\2\\end{matrix}\\right]\\right )$'
     else:
         assert app.user_ns['a'][0]['text/plain'] ==  '(True, False)'
         assert 'text/latex' not in app.user_ns['a'][0]
@@ -147,7 +147,7 @@ def test_builtin_containers():
 ([ ],)
  [2]  \
 """
-        assert app.user_ns['c'][0]['text/latex'] == '$$\\begin{equation*}\\left ( \\left[\\begin{matrix}1\\\\2\\end{matrix}\\right]\\right )\\end{equation*}$$'
+        assert app.user_ns['c'][0]['text/latex'] == '$\\displaystyle \\left ( \\left[\\begin{matrix}1\\\\2\\end{matrix}\\right]\\right )$'
 
 def test_matplotlib_bad_latex():
     # Initialize and setup IPython session
diff --git a/sympy/printing/tests/test_latex.py b/sympy/printing/tests/test_latex.py
--- a/sympy/printing/tests/test_latex.py
+++ b/sympy/printing/tests/test_latex.py
@@ -564,7 +564,7 @@ def test_latex_derivatives():
 
     # use ordinary d when one of the variables has been integrated out
     assert latex(diff(Integral(exp(-x * y), (x, 0, oo)), y, evaluate=False)) == \
-        r"\frac{d}{d y} \int_{0}^{\infty} e^{- x y}\, dx"
+        r"\frac{d}{d y} \int\limits_{0}^{\infty} e^{- x y}\, dx"
 
     # Derivative wrapped in power:
     assert latex(diff(x, x, evaluate=False)**2) == \
@@ -584,15 +584,15 @@ def test_latex_subs():
 
 def test_latex_integrals():
     assert latex(Integral(log(x), x)) == r"\int \log{\left (x \right )}\, dx"
-    assert latex(Integral(x**2, (x, 0, 1))) == r"\int_{0}^{1} x^{2}\, dx"
-    assert latex(Integral(x**2, (x, 10, 20))) == r"\int_{10}^{20} x^{2}\, dx"
+    assert latex(Integral(x**2, (x, 0, 1))) == r"\int\limits_{0}^{1} x^{2}\, dx"
+    assert latex(Integral(x**2, (x, 10, 20))) == r"\int\limits_{10}^{20} x^{2}\, dx"
     assert latex(Integral(
-        y*x**2, (x, 0, 1), y)) == r"\int\int_{0}^{1} x^{2} y\, dx\, dy"
+        y*x**2, (x, 0, 1), y)) == r"\int\int\limits_{0}^{1} x^{2} y\, dx\, dy"
     assert latex(Integral(y*x**2, (x, 0, 1), y), mode='equation*') \
         == r"\begin{equation*}\int\int\limits_{0}^{1} x^{2} y\, dx\, dy\end{equation*}"
     assert latex(Integral(y*x**2, (x, 0, 1), y), mode='equation*', itex=True) \
         == r"$$\int\int_{0}^{1} x^{2} y\, dx\, dy$$"
-    assert latex(Integral(x, (x, 0))) == r"\int^{0} x\, dx"
+    assert latex(Integral(x, (x, 0))) == r"\int\limits^{0} x\, dx"
     assert latex(Integral(x*y, x, y)) == r"\iint x y\, dx\, dy"
     assert latex(Integral(x*y*z, x, y, z)) == r"\iiint x y z\, dx\, dy\, dz"
     assert latex(Integral(x*y*z*t, x, y, z, t)) == \
@@ -600,7 +600,7 @@ def test_latex_integrals():
     assert latex(Integral(x, x, x, x, x, x, x)) == \
         r"\int\int\int\int\int\int x\, dx\, dx\, dx\, dx\, dx\, dx"
     assert latex(Integral(x, x, y, (z, 0, 1))) == \
-        r"\int_{0}^{1}\int\int x\, dx\, dy\, dz"
+        r"\int\limits_{0}^{1}\int\int x\, dx\, dy\, dz"
 
     # fix issue #10806
     assert latex(Integral(z, z)**2) == r"\left(\int z\, dz\right)^{2}"