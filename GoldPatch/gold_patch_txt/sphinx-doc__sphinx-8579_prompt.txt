# 修复代码生成提示词（实例ID：sphinx-doc__sphinx-8579）
## 代码仓库
sphinx-doc/sphinx

## 原始问题描述
Linkcheck crashes in 3.4.0
**Describe the bug**

When running linkcheck in Weblate docs, it crashes with:

```
 Exception in thread Thread-2:
Traceback (most recent call last):
  File "/opt/hostedtoolcache/Python/3.8.6/x64/lib/python3.8/threading.py", line 932, in _bootstrap_inner

Exception occurred:
    self.run()
  File "/opt/hostedtoolcache/Python/3.8.6/x64/lib/python3.8/threading.py", line 870, in run
    self._target(*self._args, **self._kwargs)
  File "/opt/hostedtoolcache/Python/3.8.6/x64/lib/python3.8/site-packages/sphinx/builders/linkcheck.py", line 298, in check_thread
    self.wqueue.task_done()
  File "/opt/hostedtoolcache/Python/3.8.6/x64/lib/python3.8/queue.py", line 74, in task_done
Error:     raise ValueError('task_done() called too many times')
ValueError: task_done() called too many times
  File "/opt/hostedtoolcache/Python/3.8.6/x64/lib/python3.8/queue.py", line 233, in _put
    heappush(self.queue, item)
TypeError: '<' not supported between instances of 'int' and 'NoneType'
```

**To Reproduce**
Steps to reproduce the behavior:
```
<Paste your command-line here which cause the problem>

$ git clone https://github.com/WeblateOrg/weblate.git
$ cd weblate
$ pip install -r docs/requirements.txt
$ cd docs
$ make linkcheck
```

**Expected behavior**
No crash :-)

**Your project**
https://github.com/WeblateOrg/weblate/tree/master/docs

**Screenshots**
CI failure: https://github.com/WeblateOrg/weblate/runs/1585580811?check_suite_focus=true

**Environment info**
- OS: Linux
- Python version: 3.8.6
- Sphinx version: 3.4.0
- Sphinx extensions:  several, but should not be relevant here
- Extra tools: none involved

**Additional context**
Add any other context about the problem here.

- [e.g. URL or Ticket]




## 参考黄金补丁（正确的修复方案）
diff --git a/tests/roots/test-linkcheck-localserver-two-links/conf.py b/tests/roots/test-linkcheck-localserver-two-links/conf.py
new file mode 100644
--- /dev/null
+++ b/tests/roots/test-linkcheck-localserver-two-links/conf.py
@@ -0,0 +1 @@
+exclude_patterns = ['_build']
diff --git a/tests/roots/test-linkcheck-localserver-two-links/index.rst b/tests/roots/test-linkcheck-localserver-two-links/index.rst
new file mode 100644
--- /dev/null
+++ b/tests/roots/test-linkcheck-localserver-two-links/index.rst
@@ -0,0 +1,6 @@
+.. image:: http://localhost:7777/
+   :target: http://localhost:7777/
+
+`weblate.org`_
+
+.. _weblate.org: http://localhost:7777/
diff --git a/tests/test_build_linkcheck.py b/tests/test_build_linkcheck.py
--- a/tests/test_build_linkcheck.py
+++ b/tests/test_build_linkcheck.py
@@ -573,3 +573,40 @@ def test_limit_rate_bails_out_after_waiting_max_time(app):
     checker.rate_limits = {"localhost": RateLimit(90.0, 0.0)}
     next_check = checker.limit_rate(FakeResponse())
     assert next_check is None
+
+
+@pytest.mark.sphinx(
+    'linkcheck', testroot='linkcheck-localserver-two-links', freshenv=True,
+)
+def test_priorityqueue_items_are_comparable(app):
+    with http_server(OKHandler):
+        app.builder.build_all()
+    content = (app.outdir / 'output.json').read_text()
+    rows = [json.loads(x) for x in sorted(content.splitlines())]
+    assert rows == [
+        {
+            'filename': 'index.rst',
+            # Should not be None.
+            'lineno': 0,
+            'status': 'working',
+            'code': 0,
+            'uri': 'http://localhost:7777/',
+            'info': '',
+        },
+        {
+            'filename': 'index.rst',
+            'lineno': 0,
+            'status': 'working',
+            'code': 0,
+            'uri': 'http://localhost:7777/',
+            'info': '',
+        },
+        {
+            'filename': 'index.rst',
+            'lineno': 4,
+            'status': 'working',
+            'code': 0,
+            'uri': 'http://localhost:7777/',
+            'info': '',
+        }
+    ]